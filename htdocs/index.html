<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,intial-scale=1">
<title>Vault of Cardboard</title>
<link rel="stylesheet" type="text/css" href="/css/keyrune.min.css" />
<link rel="stylesheet" type="text/css" href="/css/mana.min.css" />
<link rel="stylesheet" type="text/css" href="/css/vcb.css" />
</head>
<body>
<div id="app"></div>

<script type="text/html" id="template:play-card"><!-- {{{ -->
  <img class="c" id="[[= _.id ]]" src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.image ]]"
       [[ if (_.card.layout == 'transform') { ]]data-flip-src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.back ]]"[[ } ]]
       draggable="true"
       alt="[[= _.card.name ]]" title="[[= _.card.name ]]">
</script><!-- }}} -->
<script type="text/html" id="template:play"><!-- {{{ -->
  <div class="play">
    <div class="wash"></div>
    <div class="draw strip"><div class="cards"></div></div>
    <div class="board">
      <div class="zones">
        <div class="empty command zone"  ><img class="placeholder" src="/play/command-zone.png"></div>
        <div class="empty exile zone"    ><img class="placeholder" src="/play/exile.png"><ul><li><a href="#" rel="search">search</a></li><li></ul></div>
        <div class="library"><img class="placeholder" src="/play/library.png"><img class="back" src="/img/mtgback.jpg"><ul><li><a href="#" rel="draw">draw</a></li><li><a href="#" rel="search">search</a></li><li><a href="#" rel="exile">exile</a></li></ul></div>
        <div class="empty graveyard zone"><img class="placeholder" src="/play/graveyard.png"><ul><li><a href="#" rel="search">search</a></li><li><a href="#" rel="exile">exile</a></li></ul></div>
      </div>
      <div class="battlefield"></div>
      <div class="inspect">
        <img>
        <div class="h2h">
          <div class="p ap">
            <h2>
              K-A-A-L-I-A Kaaaaaaaalia!
              <span class="active">AP</span>
            </h2>
            <div class="stats">
              <div class="details">
                <p>Ima throw down some angels and demons, mmkay?</p>
                <span class="colors">[[= cardboard.colorize('WUB') ]]</span>

                <div class="poison gauge">
                  <span class="n">9</span>
                  <div class="fill"></div>
                  <label>poison<label>
                </div>

                <div class="commander-damage gauge">
                  <span class="n">19</span>
                  <div class="fill"></div>
                  <label>Silver Queen<label>
                </div>
                <div class="commander-damage gauge">
                  <span class="n">4</span>
                  <div class="fill"></div>
                  <label>Muldrotha<label>
                </div>
                <div class="commander-damage gauge">
                  <span class="n">2</span>
                  <div class="fill"></div>
                  <label>Niv-Mizzet<label>
                </div>
              </div>
              <div class="side">
                <div class="life total">
                  <span>20</span>
                  <label>Life</label>
                </div>

                <div class="energy counters">
                  <span>5</span>
                  <label>energy</label>
                </div>

                <div class="xp counters">
                  <span>1</span>
                  <label>xp</label>
                </div>
              </div>
            </div>
          </div>
          <!--
          <div class="sep"><span>vs</span></div>
          <div class="p nap">
            <h2>
              <span class="ap">AP</span>
              <span class="nap">NAP</span>
              What Even Are Slivers, Anyway?
              <span class="colors">[[= cardboard.colorize('C') ]]</span>
            </h2>
            <ul class="stats">
              <li class="life">20</li>
            </ul>
          </div>
          -->
        </div>
      </div>
    </div>
    <div class="hand"></div>
  </div>
</script><!-- }}} -->
<script type="text/html" id="template:play-draw"><!-- {{{ -->
  <div class="cards">
    [[ for (var i = 0; i < _.cards.length; i++) { ]]
      [[ include('play-card', _.cards[i]); ]]
    [[ } ]]
    [[ if (_.mode == 'draw') { ]]
      <img src="/img/mtgback.jpg">
    [[ } ]]
    <ul class="button">
      [[ if (_.mode == 'draw') { ]]
      <li><a href="#" rel="put-in-hand">ok</a></li>
      [[ } ]]
    </ul>
  </div>
</script><!-- }}} -->

<script type="text/html" id="template:cardface"><!-- {{{ -->
  [[ var alt = _.card.name + ' [' + _.card.set.code + ']'; ]]
  <span data-own="[[= _.owned ]]">
    [[ if (!_.noback) { ]]<span class="card back"><img src="/img/mtgback.jpg"></span>[[ } ]]
    <span class="card face [[= _.card.layout]]">
      [[ if (_.card.layout == 'transform') { ]]<a href="#" rel="flip"></a>[[ } ]]
      <img data-id="[[= _.card.id ]]" src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.image ]]"
           [[ if (_.card.layout == 'transform') { ]]data-flip-src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.back ]]"[[ } ]]
           alt="[[= alt ]]" title="[[= alt ]]">
    </span>
  </span>
</script><!-- }}} -->

<script type="text/html" id="template:clarify"><!-- {{{ -->
  [[
    $.each(_.problems, function (i, problem) {
      include('problem', $.extend({ i: i }, problem));
    });
  ]]
</script><!-- }}} -->
<script type="text/html" id="template:problem"><!-- {{{ -->
  <div class="problem" data-problem="[[= _.i ]]">
    <p>line <span class="lineno">[[= _.wanted.lineno ]]</span>:
            <span class="line">[[= _.wanted.card ]][[ if (_.wanted.set) { ]] (in [[= _.wanted.set ]])[[ } ]]</span>:
            <span class="problem">[[= _.description ]]</span></p>
    <div class="grid results">
    [[ $.each(_.candidates, function (j, candidate) {
         var card = $INDEX[candidate];
         if (!card) {
           console.log("unable to locate card id %s in $INDEX... skipping!", candidate);
           return;
         } ]]
      <span data-vif="[[= card.set.code ]] [[= card.name ]]">
        [[ include('cardface', { owned: 0, card: card }); ]]
        <span class="clarif"><span class="band"><a href="#" rel="dec">◀</a> <span>0</span> <a href="#" rel="inc">▶</a></span></span>
      </span>
    [[ }); ]]
    </div>
    <ul class="changes"></ul>
    [[ if (_.candidates.length > 0) { ]]<button rel="re-validate">Apply Changes</button>[[ } ]]
  </div>
</script><!-- }}} -->

<script type="text/html" id="template:decks"><!-- {{{ -->
  <div class="decks prose">
    <h1>Your Decks</h1>
    [[ if (_.decks && _.decks.length > 0) { ]]
      <button rel="new-deck">New Deck</button>
      <table class="decks sortable listing">
        <thead><tr>
          <th class="sortable">Code</th>
          <th class="sortable">Name</th>
          <th class="sortable" data-sort-as="number">Created</th>
          <th class="sortable" data-sort-as="number">Last Updated</th>
        </tr></thead>
        <tbody>
        [[ $.each(_.decks, function (i, deck) { ]]
          <tr>
            <td><a href="#!/deck/[[= deck.code ]]">[[= deck.code ]]</a></td>
            <td><a href="#!/deck/[[= deck.code ]]">[[= deck.name ]]</a></td>
            <td data-sort="[[= deck.created_at ]]">[[= strftime("%B %Oe, %Y", dated(deck.created_at)) ]]</td>
            <td data-sort="[[= deck.updated_at ]]">[[= strftime("%B %Oe, %Y", dated(deck.updated_at)) ]]</td>
          </tr>
        [[ }); ]]
        </tbody>
      </table>
    [[ } else { ]]
      <p>You have no decks!</p>

      [[ include("import-deck"); ]]
    [[ } ]]
  </div>
</script><!-- }}} -->
<script type="text/html" id="template:import-deck"><!-- {{{ -->
  <div class="prose">
    <h1>Import a Deck</h1>
    <form id="deck" class="import">
      <div><label for="code">Internal Identifier</label>
           <input type="text" name="code"
                  class="autofocus"
                  placeholder="A unique ID to use with 'in:...' queries"
                  data-validate="present;min=2;max=40"
                  data-error-if-missing="Please provide an internal identifier, for use in querying the contents of this deck."
                  data-error-out-of-bounds="Identifiers must be between 2 and 40 characters long."
                  autocomplete="off">
      </div>

      <div><label for="name">Deck Name</label>
           <input type="text" name="name"
                  class="autofocus"
                  placeholder="A name for this deck, which will be displayed to others."
                  data-validate="present;min=2"
                  data-error-if-missing="Please provide a name for this deck."
                  data-error-out-of-bounds="Deck names must be at least two characters long."
                  autocomplete="off">

      </div>

      <div><label for="notes">Notes</label>
           <textarea name="notes" placeholder="(feel free to expound on the premise and power of your deck...)"
                     data-validate="max=2000"></textarea>
      </div>
      <div><label for="cardlist">Cards List</label>
           <textarea name="cardlist" class="vif"
                     data-validate="present;max=100k"
># enter your deck list here, using the following format:
# 4x NPH Darksteel Relic

</textarea>
      </div>
      <div class="oops" style="display: none"></div>
      <div class="clarify"></div>
      <div>
        <button class="default safe" data-in-progress="Importing..." type="submit">Import</button></form>
      </div>
    </form>
  </div>
</script><!-- }}} -->
<script type="text/html" id="template:edit-deck"><!-- {{{ -->
  <div class="prose">
    <h1>Import a Deck</h1>
    <form id="deck" class="import">
      <input type="hidden" name="id" value="[[= _.deck.code ]]">
      <div><label for="code">Internal Identifier</label>
           <input type="text" name="code"
                  value="[[= _.deck.code ]]"
                  class="autofocus"
                  placeholder="A unique ID to use with 'in:...' queries"
                  data-validate="present;min=2;max=40"
                  data-error-if-missing="Please provide an internal identifier, for use in querying the contents of this deck."
                  data-error-out-of-bounds="Identifiers must be between 2 and 40 characters long."
                  autocomplete="off">
      </div>

      <div><label for="name">Deck Name</label>
           <input type="text" name="name"
                  value="[[= _.deck.name ]]"
                  class="autofocus"
                  placeholder="A name for this deck, which will be displayed to others."
                  data-validate="present;min=2"
                  data-error-if-missing="Please provide a name for this deck."
                  data-error-out-of-bounds="Deck names must be at least two characters long."
                  autocomplete="off">

      </div>

      <div><label for="notes">Notes</label>
           <textarea name="notes" placeholder="(feel free to expound on the premise and power of your deck...)"
                     data-validate="max=2000">[[= _.deck.notes ]]</textarea>
      </div>
      <div><label for="cardlist">Cards List</label>
           <textarea name="cardlist" class="vif"
                     data-validate="present;max=100k">[[= _.deck.cardlist ]]</textarea>
      </div>
      <div class="oops" style="display: none"></div>
      <div class="clarify"></div>
      <div>
        <button class="default safe" data-in-progress="Saving..." type="submit">Save</button></form>
      </div>
    </form>
  </div>
</script><!-- }}} -->
<script type="text/html" id="template:deck"><!-- {{{ -->
  <div class="deck prose" data-uuid="[[= _.deck.id ]]" data-id="[[= _.deck.code ]]">
    <div class="title">
      <span>in:[[= _.deck.code ]]</span>
      <h1>[[= _.deck.name ]]</h1>
    </div>
    <div class="buttons">
      <button rel="playtest">Play!</button>
      <button rel="edit-deck">Edit</button>
      <button class="danger" rel="delete-deck">Delete</button>
    </div>

    [[ if (_.deck.notes.replace(/(^\s+|\s+$)/, '') != "") { ]]
    <h2>Notes</h2>
    <div>[[= _.deck.notes ]]</div>
    [[ } ]]

    <h2>Mana Curve</h2>
    [[ var curve = [];
       var max = 0,
           min = undefined;
       for (var i = 0; i < _.deck.cards.cards.length; i++) {
         var card = _.deck.cards.oracle[_.deck.cards.cards[i].replace(/\/.*/,'' )];
         if (card.type.match(/\bLand\b/)) {
           continue;
         }
         if (!(card.cmc in curve)) {
           curve[card.cmc] = [];
         }
         curve[card.cmc].push(card);
         if (card.cmc > max) {
           max = card.cmc;
         }
         if (typeof min === 'undefined' || card.cmc < min) {
           min = card.cmc;
         }
       }

       for (var i = 0; i <= max; i++) {
         if (!curve[i]) {
           curve[i] = [];
         }
       }
    ]]
    <div class="curve">
      [[ for (var i = min; i < curve.length; i++) { ]]
      <div>
        <ul>
        [[ for (var j = 0; j < curve[i].length; j++) {
             var c = curve[i][j];
             var alt = c.name + ' [' + c.set.code + ']'; ]]
          <li><img data-id="[[= c.id ]]"
                   src="[[= $CONFIG.imgroot ]]/cards/[[= c.image ]]"
                   alt="[[= alt ]]" title="[[= alt ]]"></li>
        [[ } ]]
        </ul>
        <p>[[= i ]]</p>
      </div>
      [[ } ]]
    </div>

    <h2>Sample Hand</h2>
    <button rel="mulligan">Mulligan!</button>
    [[ var lib = [];
       for (var i = 0; i < _.deck.cards.cards.length; i++) {
         lib.push(_.deck.cards.oracle[_.deck.cards.cards[i].replace(/\/.*/,'' )]);
       }
    ]]
    [[ for (var cards = 7; cards > 2; cards--) { ]]
      [[ lib = window.shuffle(lib); ]]
    <div class="hand">[[ include('deck-hand', { n: 14, hand: cards, lib: lib }); ]]</div>
    [[ } ]]

    <h2>What's In It?</h2>
    <pre class="rawlist"><code>[[= _.deck.cardlist ]]</code></pre>

  </div>
</script><!-- }}} -->
<script type="text/html" id="template:deck-hand"><!-- {{{ -->
  [[ var lib = window.shuffle(_.lib); ]]
  <ul>
    [[ for (var i = 0; i < Math.min(_.n, lib.length); i++) { ]]
      [[ if (i % 7 == 0) { ]]</ul><ul>[[ } ]]
      [[ var alt = lib[i].name + ' [' + lib[i].set.code + ']'; ]]
      <li class="[[= i >= _.hand ? 'draw' : 'open' ]]">
        <img data-id="[[= lib[i].id ]]"
             src="[[= $CONFIG.imgroot ]]/cards/[[= lib[i].image ]]"
             alt="[[= alt ]]" title="[[= alt ]]"></li>
    [[ } ]]
  </ul>
</script><!-- }}} -->

<script type="text/javascript">
  var $CONFIG = {
    imgroot: "//vault-of-cardboard.s3.amazonaws.com"
  };
</script>
<script src="https://vuejs.org/js/vue.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/lens.js"></script>
<script type="text/javascript" src="js/forms.js"></script>
<script type="text/javascript" src="js/diff.js"></script>
<script type="text/javascript" src="js/clarify.js"></script>
<script type="text/javascript" src="js/play.js"></script>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="/js/cardboard.min.js"></script>
<script type="text/javascript">
Vue.component('copyright-footer', {
  data() { return {}; },
  template: `
<footer>
  Magic: The Gathering is a Trademark of Wizards of the Coast, Inc. and Hasbro, Inc.<br/>
  Vault of Cardboard is Copyright &copy; 2020 <a href="https://jameshunt.us">James Hunt</a>
</footer>
`
});

Vue.component('loading', {
  data() {
    return {
      quotes: [
        /* flavor:canto or flavor:"Song" */
        /* Arbor Armament (DOM) */
        "<blockquote>&ldquo;Llanowar's boughs are ever ready<br>To unleash an autumn of steel leaves.&rdquo;<cite>&mdash;&ldquo;Song of Freyalise&rdquo;</cite></blockquote>",

        /* Blinding Light (MIR) */
        "<blockquote>&ldquo;My shield will bear a shining sun so you will always be with me. / Inlaid with gold, it will shine like glowing embers.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Chariot of the Sun (MIR) */
        "<blockquote>&ldquo;Sun follows Moon until she tires, then carries her until she's strong / and runs ahead of him again.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Congregate (A25) */
        "<blockquote>&ldquo;In the gathering there is strength for all who founder, renewal for all who languish, love for all who sing.&rdquo;<cite>&mdash;Song of All, canto 642</cite></blockquote>",

        /* Defensive Formation (USG) */
        "<blockquote>&ldquo;Your enemies will pound upon the door of your defenses, but only you shall have the key, and it is the key of life.&rdquo;<cite>&mdash;Song of All, canto 873</cite></blockquote>",

        /* Disenchant (A25) */
        "<blockquote>&ldquo;The tools of evil are mere things. And like all things, they cannot last forever.&rdquo;<cite>&mdash;Song of All, canto 881</cite></blockquote>",

        /* Early Harvest (MIR) */
        "<blockquote>&ldquo;Tonight we'll eat a farewell feast. Cold corn porridge is not enough. / Let's peel papayas, pineapples, and mangoes, drink coconut milk, / and bake bananas.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Femeref Knight (MIR) */
        "<blockquote>&ldquo;I will return / with lizard skins for your sandals. Paint your eyes black and wait for me.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Flare (MIR) */
        "<blockquote>&ldquo;In the forest, fires light the sky as black clouds unfold their weight.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Invoke the Divine (DOM) */
        "<blockquote>&ldquo;Let go of all that harms you. Cast your burdens into the darkness, and build for the faithful a house of light.&rdquo;<cite>&mdash;Song of All, canto 1008</cite></blockquote>",

        /* Kukemssa Pirates (MIR) */
        "<blockquote>&ldquo;. . . pirates gambled with a djinn and lost the thing more dear than gold.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* On Serra's Wings (DOM) */
        "<blockquote>&ldquo;The spirit of Serra raised Brindri high and commanded her to keep the balance.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

        /* Pegasus Charger (USG) */
        "<blockquote>&ldquo;The clouds came alive and dove to the earth! Hooves flashed among the dark army, who fled before the spectacle of fury.&rdquo;<cite>&mdash;Song of All, canto 211</cite></blockquote>",

        /* Planar Birth (USG) */
        "<blockquote>&ldquo;From womb of nothingness sprang this place of beauty, purity, and hope realized.&rdquo;<cite>&mdash;Song of All, canto 3</cite></blockquote>",

        /* Sacred Mesa (MIR) */
        "<blockquote>&ldquo;Do not go there, do not go / unless you rise on wings, unless you walk on hooves.&rdquo;<cite>&mdash;&ldquo;Song to the Sun,&rdquo; Femeref song</cite></blockquote>",

        /* Serra Avenger (TSP) */
        "<blockquote>&ldquo;Those who endure in the face of suffering, those whose faith shines long in evil days, they shall see salvation.&rdquo;<cite>&mdash;Song of All, canto 904</cite></blockquote>",

        /* Serra's Embrace (USG) */
        "<blockquote>&ldquo;Lifted beyond herself, for that battle Brindri was an angel of light and fury.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

        /* Unfulfilled Desires (MIR) */
        "<blockquote>&ldquo;Like Day from Night, / I'll live my life apart from you, just glimpsing you across the sky, / because you cannot change, my dear, and nor can I.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Village Elder (MIR) */
        "<blockquote>&ldquo;Enchant me with your tale-telling. Tell about Tree, Grass, River, and Wind. / Tell why Truth must fight with Falsehood, and why Truth will always win.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Voice of Grace (USG) */
        "<blockquote>&ldquo;Opposite Law is Grace, and Grace must be preserved. If the strands of Grace are unraveled, its design will be lost, and the people with it.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

        /* Voice of Law (USG) */
        "<blockquote>&ldquo;Life's balance is as a star: on one point is Law, and Law must be upheld. If the knots of order are loosened, chaos will spill through.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

        /* Wild Elephant (MIR) */
        "<blockquote>&ldquo;I will tell my father's stories . . . . How the elephants trampled the leopard cub, and its father, though he knew, killed nine goats instead.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Wildgrowth Walker (XLN) */
        "<blockquote>&ldquo;Hear me, stone, root, branch: be the fist of this land. Turn back those who trample upon your domain.&rdquo;<cite>&mdash;Song of the Shaper</cite></blockquote>",

        /* Zebra Unicorn (MIR) */
        "<blockquote>&ldquo;I'll capture gentle zebras / for your steeds and fill the stable with every kind of unicorn.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Zhalfirin Knight (MIR) */
        "<blockquote>&ldquo;You returned a warrior. . . . Your hair was cut, your eye tattooed with the red triangle of war.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>"
      ],
      current: 0,
      next:    1,
    };
  },
  mounted() {
    window.setInterval(() => { this.advance(); }, 7700);
    this.next = parseInt(Math.random() * this.quotes.length);
    this.advance();
  },
  methods: {
    advance() {
      this.current = this.next;
      this.next = parseInt(Math.random() * (this.quotes.length - 1));
      if (this.next >= this.current) {
        this.next++;
      }
    }
  },
  template: `
<div class="loading">
  <h1>Loading...</h1>
  <p class="marquee" v-html="quotes[current]"></p>
</div>
`
});

Vue.component('login', {
  props: {
    error: {
      type: String,
      required: false,
    }
  },
  data() {
    return {
      username: '',
      password: ''
    };
  },
  mounted() {
    $('[name=username]').focus();
  },
  methods: {
    colorize: cardboard.colorize,
    authenticate(username, password) {
      event.preventDefault();
      fetch('/v1/authenticate', {
        method: 'POST',
        body:   JSON.stringify({
          username: username,
          password: password
        })
      }).then(r => {
        if (!r.ok) { throw new Error('bad response'); }
        return r.json();
      }).then((data) => {
        if (data.authenticated) {
          UI.vault.unload_collection();

          UI.session = {
            username : data.authenticated.username,
            uid      : data.authenticated.uid,
            id       : data.authenticated.session
          };
          document.cookie = 'vcb_sesh='+data.authenticated.session+';max-age=7776000;samesite=strict';
          fetch('/collectors/'+UI.session.uid+'/collections/_/collection.json').then(r => {
            if (!r.ok) { throw new Error('HTTP request failed'); }
            return r.json();
          }).then(raw => UI.vault.load_collection(raw[0] || [], raw[1] || []));
          UI.browse('/q/owned');
        } else {
          UI.error = data.response.message;
        }
      });
    }
  },
  template: `
<div class="landing login">
  <div><img src="/img/front.png"></div>
  <div>
    <p>Whether you're putting together <a href="#!/q/type:sliver">that Sliver deck,</a>
    seeking out <a href="#!/q/type:legendary and type:creature">your next Commander,</a>
    or <a href="#!/q/Didgeridoo or type:Minotaur">just looking for some jank</a>,
    <em>Vault of Cardboard</em> has got you covered.</p>

    <form id="login" @submit="authenticate(username, password)">
      <div class="oops" v-if="error == 'authentication-failed'">
        Invalid username or password.
      </div>
      <div class="oops" v-else-if="error">
        Uh-oh, something broke pretty bad.  Tap {{ colorize("2UUU") }} and summon James, Fixer of Codes!
        <!-- Uh-oh, something broke pretty bad.  Tap {{ colorize("4BR") }} to cast James Legendary Bug Fix -->
      </div>
      <div>
        <label>Username</label>
        <input type="text" name="username" autocomplete="off" v-model="username">
      </div>
      <div>
        <label>Password</label>
        <input type="password" name="password" v-model="password">
      </div>
      <div>
        <button type="submit"class="default safe">Sign in</button>
      </div>
    </form>
    <copyright-footer></copyright-footer>
  </div>
</div>
`
});

Vue.component('changelog', {
  props: ['changes'],
  mounted() {
    // FIXME this is a bit wonky right now, but it works.
    let id = document.location.hash;
    if (id.match(/^#!\/changelog\//)) {
      let $target = $('h2[id="'+id.replace(/^#/,'')+'"]');
      if ($target.length != 0) {
        $('html, body').animate({ scrollTop: $target.offset().top }, 200);
      }
    }
  },
  template: `
<div class="docs changelog prose">
  <template v-for="change in changes">
    <h2 :id="'!/changelog/' + change.release">
      <img :src="change.header">
      {{ change.title }}
      <a :href="'/#!/changelog/' + change.release">(permalink)</a>
      <span>{{ change.dated }}</span>
    </h2>
    <p v-html="change.notes"></p>
  </template>
</div>
`
});

Vue.component('docs', {
  props: ['docs'],
  template: `
<div class="sets prose">
  <div v-html="docs"></div>
</div>
`
});

Vue.component('set-list', {
  props: ['sets'],
  mounted() {
    $('#main table.sortable').sortableTable();
  },
  methods: {
    dated:    dated,
    strftime: strftime,
  },
  template: `
<div class="sets prose">
  <h1>Currently Known Magic: the Gathering Sets</h1>
  <p>These are all the M:tG sets that Vault of Cardboard knows about.
  Most of these should have images.  If a set is missing, or missing its images,
  please let us know!</p>
  <table class="sets sortable listing">
    <thead><tr>
      <th></th>
      <th class="sortable">Code</th>
      <th class="sortable">Name</th>
      <th class="sortable" data-sort-as="number">Release Date</th>
      <th class="sortable" data-sort-as="number">Size</th>
      <th></th>
    </tr></thead>
    <tbody>
      <tr v-for="set in sets"
          :key="set.code"
          :set="set">
        <td><span :class="'ss ss-' + set.code.toLowerCase()"></span></td>
        <td>{{ set.code }}</td>
        <td>{{ set.name }}</td>
        <td :data-sort="set.release">{{ strftime("%B %Oe, %Y", dated(set.release)) }}</td>
        <td :data-sort="set.size"><a :href="'#!/q/set:' + set.code">{{ set.size }}</a></td>
      </tr>
    </tbody>
  </table>
</div>
`
})
Vue.component('card-grid', {
  props: ['q', 'oops', 'cards'],
  template: `
<div class="search">
  <div v-if="oops" class="oops">{{ q }}: {{ oops }}</div>
  <div v-if="q" class="meta-results">found <span class="count">{{ cards.length }}</span> card{{ cards.length == 1 ? '' : 's' }}.</div>
  <div class="results grid">
    <card
      v-for="card in cards"
      :key="card.id"
      :card="card"></card>
  </div>
</div>
`
});

Vue.component('card', {
  props: ['card'],
  data() {
    return {
      imgroot: $CONFIG.imgroot,
    };
  },
  template: `
<span :data-own="card.owned">
  <span class="card back"><img src="/img/mtgback.jpg"></span>
  <span :class="'card face ' + card.layout">
    <a v-if="card.layout == 'transform'" href="#" rel="flip"></a>
    <img :data-id="card.id" :src="imgroot + '/cards/' + card.image"
         :alt="card.name + ' [' + card.set.code + ']'"
         :title="card.name + ' [' + card.set.code + ']'"
         :data-flip-src="imgroot + '/cards/' + card.back">
  </span>
</span>
`
});

Vue.component('card-detail', {
  props: ['card'],
  data() {
    return {
      imgroot: $CONFIG.imgroot,
    };
  },
  methods: {
    colorize: cardboard.colorize,
    price(d) {
      return '$'+d.toFixed(2).split('').reverse().join('').match(/.{1,3}/g).join(',').split('').reverse().join('').replace(/,\./, '.');
    },
    oracle(card) {
      return cardboard.symbolize(card.oracle).replace(/\n/g, '</p></p>');
    }
  },
  template: `
<div class="modal-fg">
  <div class="cardable">

  </div>
  <div class="cardable" :data-own="card.owned"><div>
    <span class="card back"><img src="/img/mtgback.jpg"></span>
    <span :class="'card face ' + card.layout">
      <a v-if="card.layout == 'transform'" href="#" rel="flip"></a>
      <img :data-id="card.id" :src="imgroot + '/cards/' + card.image"
           :alt="card.name + ' [' + card.set.code + ']'"
           :title="card.name + ' [' + card.set.code + ']'"
           :data-flip-src="imgroot + '/cards/' + card.back">
    </span>
  </div></div>
  <div class="detail">
    <a class="close" href="#">X</a>
    <ul class="info">
      <li><strong>{{ card.name }}</strong></li>
      <li><em>{{ card.type }}</em></li>
      <li>{{ card.set.name }} ({{ card.set.code }})</li>
      <li>#{{ card.number }}/{{ card.set.total }}</li>
      <li v-html="colorize(card.color)"></li>
      <li><strong>CMC:</strong> {{ card.cmc }}</li>
      <li>{{ card.rarity }}</li>
    </ul>
    <ul class="owned">
      <li><strong>Owned:</strong> {{ card.owned }}</li>
    </ul>
    <ul>
      <li class="oracle"><p v-html="oracle(card)"></p></li>
    </ul>
    <p v-if="card.price" class="price">
      {{ price(card.price) }}
      <span v-if="card.price > 999" class="w1">remember kids, M:tG is <strong>NOT</strong> an investment...</span>
      <span v-else-if="card.price > 99" class="w2">oof</span>
      <span v-else-if="card.price > 9" class="w3">that's a bit much, don't you think?</span>
    </p>
  </div>
</div>
`
});

Vue.component('timeline', {
  props: ['transactions'],
  data: function () {
    return {
      target: '',
      mode: 'view'
    };
  },
  computed: {
    total_cards() {
      let v = 0;
      this.transactions.forEach(t => {
        v += t.total_card_gain  - t.total_card_loss;
      });
      return v;
    },
    total_unique_cards() {
      let v = 0;
      this.transactions.forEach(t => {
        v += t.unique_card_gain - t.unique_card_loss;
      });
      return v;
    },

    monthly_bands() {
      let by_date = new Map();

      this.transactions.forEach(t => {
        t.total_delta  = t.total_card_gain  - t.total_card_loss;
        t.unique_delta = t.unique_card_gain - t.unique_card_loss;

        t.type = ((gained, lost) => {
          if (gained && lost) { return 'trade'; }
          if (gained)         { return 'buy';   }
          if (lost)           { return 'sell';   }
          return 'no-op';
        })(t.total_card_gain > 0, t.total_card_loss > 0);

        var d = t.dated;
        d = d ? parseInt(d.replace(/-/g, '')) : undefined;
        d = d ? (100 * parseInt(d / 100) + 5).toString() : '0';

        if (!by_date.has(d)) {
          by_date.set(d, {
            total_delta:  0,
            unique_delta: 0,
            transactions: []
          });
        }
        let x = by_date.get(d);
        x.transactions.push(t);
        x.total_delta  += t.total_delta;
        x.unique_delta += t.unique_delta;
        by_date.set(d, x);
      });

      let to_sort = [];
      by_date.forEach((band, d) => {
        band.transactions = band.transactions.sort((a, b) => { return b.dated - a.dated; });
        to_sort.push([d, band]);
      });

      return to_sort.sort((a, b) => { return b[0] - a[0]; });
    }
  },

  methods: {
    start_new_transaction() {
      event.preventDefault();
      this.mode = 'new';
    },

    start_edit_transaction(id) {
      event.preventDefault();
      this.target = id;
      this.mode = 'edit';
    },

    new_transaction(ev) {
      console.log('new transaction');
      console.log(ev);
      this.transactions.push(ev.transaction);
      this.mode = 'view';
    },

    updated_transaction(ev) {
      console.log('update transaction');
      console.log(ev);

      for (var i = 0; i < this.transactions.length; i++) {
        if (this.transactions[i].id == ev.transaction.id) {
          this.transactions[i] = ev.transaction;
          break;
        }
      }
      this.mode = 'view';
    },

    gainloss(n) {
      return n < 0 ? 'loss' : n > 0 ? 'gain' : '';
    },

    heading(d) {
      return parseInt(d) ? strftime("%B %Y", dated(d)) : "The Beginning";
    },

    sprintf: sprintf
  },
  template: `
<div class="prose">
  <template v-if="transactions.length == 0">
    <h1>Let's Get You A <em>Collection</em>...</h1>
    <p>We don't have a clue what's in your collection.<br>
       Why don't we fix that, and get to know one another better?</p>

    <form id="buy" class="import">
      <input type="hidden" name="summary" value="Initial import">
      <input type="hidden" name="type"    value="import">
      <div>
        <label for="raw_gain">What Cards Do You Own?</label>
        <textarea name="raw_gain" class="vif"
                  data-validate="present;max=100k"># enter your list of cards here, i.e.:
# 1x M19 Arcades, the Strategist

</textarea>
      </div>
      <div>
        <button class="default safe" data-in-progress="Saving..." type="submit">Save</button>
      </div>
    </form>
  </template>
  <template v-else>
    <h1>Your Magic Collection <em>Through Time!</em></h1>
    <div class="timeline">
      <div class="now summary">
        <h2>Today</h2>
        <ul>
          <li><em>{{ total_cards }}</em> cards (<em>{{ total_unique_cards }}</em> unique)</li>
        </ul>

        <div class="buttons" v-if="mode != 'new'">
          <button class="buy"  rel="new-buy" @click="start_new_transaction()">Buy / Sell / Trade</button>
        </div>
        <transaction-form v-else mode="new" @new-transaction="new_transaction($event)"></transaction-form>
      </div>

      <div v-for="d in monthly_bands" class="aggr">
        <h2>{{ heading(d[0]) }} <span :class="gainloss(d[1].total_delta)">{{ sprintf("%+d", d[1].total_delta) }} cards <span :class="gainloss(d[1].unique_delta)">({{ sprintf("%+d", d[1].unique_delta) }} unique)</span></span></h2>
        <ul>
          <li v-for="txn in d[1].transactions" :class="txn.type">
            <em :class="gainloss(txn.total_delta)">{{ sprintf("%+d", txn.total_delta) }}</em> cards in {{ txn.type }} <strong>{{ txn.summary }}</strong> ({{ txn.dated }}) <span class="actions"><a @click="start_edit_transaction(txn.id)">edit</a></span>
            <transaction-form v-if="mode == 'edit' && target == txn.id" mode="edit" :transaction="txn"></transaction-form>
          </li>
        </ul>
      </div>
    </div>
  </template>
</div>
`
});

Vue.component('transaction-form', {
  props: {
    mode: String,
    transaction: {
      type: Object,
      default: function() {
        return {
          summary:     '',
          dated: (new Date()).toISOString().slice(0,10),
          notes:       '',
          gain:        '',
          loss:        ''
        };
      }
    }
  },
  data() {
    return {
    };
  },
  methods: {
    today() {
      // YYYY-MM-DD format = the first 10 chars in ISO format
      return (new Date()).toISOString().slice(0,10);
    },
    save() {
      event.preventDefault();

      if (this.transaction.id) {
        fetch('/v1/collectors/'+UI.session.uid+'/collections/_/transactions/'+this.transaction.id, {
          method: 'PATCH',
          headers: new Headers({
            'Authorization': 'Basic '+btoa(UI.session.session+':')
          }),
          body: JSON.stringify({
            summary: this.transaction.summary,
            notes:   this.transaction.notes,
            dated:   this.transaction.dated,
            gain:    this.transaction.gain,
            loss:    this.transaction.loss
          })
        }).then(r => {
          if (!r.ok) { throw new Error('unable to update transaction'); }
          return r.json();
        }).then((data) => {
          console.log("got response: ", data);
        });

      } else {
        fetch('/v1/collectors/'+UI.session.uid+'/collections/_/transactions', {
          method: 'POST',
          headers: new Headers({
            'Authorization': 'Basic '+btoa(UI.session.session+':')
          }),
          body: JSON.stringify({
            summary: this.transaction.summary,
            notes:   this.transaction.notes,
            dated:   this.transaction.dated,
            gain:    this.transaction.gain,
            loss:    this.transaction.loss
          })
        }).then(r => {
          if (!r.ok) { throw new Error('unable to create new transaction'); }
          return r.json();
        }).then((data) => {
          console.log("got response: ", data);
          this.$emit('new-transaction', data);
        });

      }
    },
  },
  template: `
<form :class="'transaction-form import ' + mode" @submit="save()">
  <h2 v-if="mode == 'new'">Buy / Sell / Trade Cards</h2>
  <h2 v-else>Update Buy / Sell / Trade Details</h2>
  <div class="band">
    <div class="control">
      <label for="summary">Summary / Transaction Name</label>
      <input type="text" name="summary" v-model="transaction.summary"
             class="autofocus"
             placeholder="A (unique-ish) name for this transaction"
             data-validate="present;min=3;max=50"
             data-error-if-missing="Please provide a name, which will be displayed in the timeline."
             data-error-out-of-bounds="Names must be between 3 and 50 characters long."
             autocomplete="off">
    </div>
  </div>
  <div class="band">
    <div class="control">
      <label for="dated">Date of Transaction</label>
      <input type="date" name="dated" v-model="transaction.dated"
             data-validate="present;format=date;happened"
             autocomplete="off">
    </div>
  </div>
  <div class="band">
    <div class="control">
      <label for="notes">Notes</label>
      <textarea name="notes" v-model="transaction.notes"
                placeholder="(notes, thoughts, context - only visible to you...)"
                data-validate="max=2000"></textarea>
    </div>
  </div>
  <div class="band">
    <div class="control gainloss gained">
      <label for="vif">Gained Cards</label>
      <textarea name="gain" v-model="transaction.gain"
                class="vif"
                data-validate="present;max=100k"></textarea>
    </div>
    <div class="control gainloss lost">
      <label for="vif">Lost Cards</label>
      <textarea name="loss" v-model="transaction.loss"
                class="vif"
                data-validate="present;max=100k"></textarea>
    </div>
    <div class="help">
      <p>VIF format is designed to be simple.<br>
         First, specify how many cards are gained or lost:</p>
      <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
      <p>Then, what set the printed cards are from:</p>
      <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
      <p>Then the full card oracle name:</p>
      <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
    </div>
  </div>

  <div>
    <button class="default safe" data-in-progress="Saving..." type="submit">Update Collection</button>
    <button v-if="mode == 'edit'" class="danger">Delete This Transaction</button>
  </div>
  </form>
`
});

let UI = new Vue({
  el: '#app',
  data: {
    // A general error, to be propagated down to all interested
    // sub-components, and conditional displayed, as needed.
    //
    error: undefined,

    // A session object, representing the currently authenticated
    // collector.  Contains their username, personal details, and
    // internal identifiers as sub-keys.
    //
    session: undefined,

    mode: 'landing',
    modal: false,

    sets: [],

    transactions: [],

    search: {
      results: []
    },

    docs: undefined,

    changes: [],

    vault: new cardboard.Vault()
  },
  mounted() {
    var session = (function () {
      var cookies = document.cookie.split(/; */);
      for (var i = 0; i < cookies.length; i++) {
        var kv = cookies[i].split('=');
        if (kv[0] == 'vcb_sesh') {
          return kv[1];
        }
      }
      return undefined;
    })();

    fetch('/cards.json').then(r => {
      if (!r.ok) { throw new Error("HTTP request failed"); }
      return r.json();
    }).then(cards => {
      this.vault.ingest(cards)
    }).catch(e => console.log('vaut:: failed to ingest card data from /cards.json: %s', e));

    if (session) {
      fetch('/v1/whoami', {
        method: 'POST',
        body:   JSON.stringify(session)
      }).then(r => {
        if (!r.ok) { throw new Error("unable to retrieve session from /v1/whoami"); }
        return r.json();
      }).then(data => {
        UI.session = data.authenticated;
      }).then(() => {
        if (!UI.session || !UI.session.uid) {
          this.vault.no_collection();
          return;
        }
        fetch('/collectors/'+UI.session.uid+'/collections/_/collection.json').then(r => {
          if (!r.ok) { throw new Error('HTTP request failed'); }
          return r.json();
        }).then(raw => this.vault.load_collection(raw[0] || [], raw[1] || []));
      });

    } else {
      this.vault.no_collection();
    }
  },
  methods: {
    logout() {
      fetch('/v1/logout', {
        method: 'POST'
      }).then(r => {
        UI.session = undefined;
        document.cookie = 'vcb_sesh=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
      });
    },

    redraw(mode) {
      if (UI.mode != mode) {
        $('html, body').animate({ scrollTop: 0 }, 200);
      }
      UI.mode = mode;
    },

    browse(url) {
      document.location.hash = '#!'+(url || '/');
      $(window).trigger('hashchange');
    },

    goto(sub) {
      if (sub == "" || sub == "login") {
        UI.redraw(sub);

      } else if (sub == "logout") {
        UI.logout();

      } else if (sub.match(/^changelog(\/.*)?$/)) {
        UI.redraw('loading');
        fetch('/changelog.json').then(r => {
          if (!r.ok) { throw new Error('failed to get changelog...'); }
          return r.json();
        }).then((data) => {
          UI.changes = data.changelog
          UI.redraw('changelog');
        });

      } else if (sub == "docs") {
        if (!UI.docs) {
          fetch('/docs.html').then(r => {
            if (!r.ok) { throw new Error('unable to load docs'); }
            return r.text();
          }).then((text) => {
            UI.docs = text;
            UI.redraw('docs');
          });
        } else {
          UI.redraw('docs');
        }

      } else if (sub == "sets") {
        UI.redraw('loading');
        UI.vault.when(cardboard.CardsLoaded, () => {
          UI.sets = UI.vault.sets;
          UI.redraw('sets');
        });

      } else if (sub.match(/^draft(\/.*)?$/)) {
        var set = sub.replace(/^draft\//, '')
                     .replace(/\/.*/, '')
                     .toUpperCase();
        UI.redraw('loading');
        UI.vault.when(cardboard.CardsLoaded, () => {
          UI.draft = new cardboard.Draft(UI.vault, {
            set: set,
            lands: set,
          }).pack();
          UI.redraw('draft');
        });

      } else if (sub.match(/^timeline(\/.*)?$/)) {
        // FIXME handle unauth
        UI.redraw('loading');
        UI.vault.when(':authenticated',
          fetch('/v1/collectors/'+UI.session.uid+'/collections/_/transactions').then(r => {
            if (!r.ok) { throw new Error('failed to fetch transactions'); }
            return r.json();
          }).then((data) => {
            UI.transactions = data.transactions;
            UI.redraw('timeline');
          }));

      } else if (sub.match(/^q\/./)) {
        UI.doSearch(decodeURIComponent(sub.replace(/^q\//, '')), false);
      }
    },

    forceSearch(q, update) {
      if (event.keyCode == 13) {
        this.doSearch(q, update);
      }
    },
    doSearch(q, update) {
      if (update) {
        document.location.hash = "#!/q/"+encodeURIComponent(q);
      }
      document.title = "VCB :: `"+q+"`";
      UI.redraw('loading');
      UI.search = { query: q, results: [] };
      UI.vault.when(cardboard.AllLoaded, () => {
        try {
          UI.search.results = UI.vault.search(q);
        } catch (e) {
          UI.search.error = e.toString();
        }
        UI.redraw('search');
      });
    },

    colorBandStyle(cards) {
      let colors = {};
      cards.forEach(card => {
        if (card.color == '') {
          colors['C'] = (colors['C'] || 0) + 1;
          colors.total = (colors.total || 0) + 1;
        } else {
          card.color.split('').forEach(color => {
            colors[color] = (colors[color] || 0) + 1;
            colors.total = (colors.total || 0) + 1;
          });
        }
      });

      var at = 0, n = 0, literal;
      var css = 'linear-gradient(90deg';
      'WUBRGC'.split('').forEach(color => {
        if (!(color in colors)) { return; }
        n++;
        css += ', ';
        switch (color) {
        case 'W': literal = '#EEE6B5'; break;
        case 'U': literal = '#375FB6'; break;
        case 'B': literal = '#333333'; break;
        case 'R': literal = '#AE4441'; break;
        case 'G': literal = '#2F7A5B'; break;
        case 'C': literal = '#CBC9C6'; break;
        }
        if (at > 0) {
          css += ' '+at+'vw, ';
        }
        css += literal;
        if (at > 0) {
          css += ' '+at+'vw'
        }
        at += colors[color] / colors.total * 100.0;
      });
      css += ')';
      if (n == 0) { literal = '#CBC9C6'; }
      if (n <  2) { css = literal; }
      return {
        background: css,
        visibility: 'visible',
        height: '7px'
      };
    },
  },
  template: `
<div id="app">
  <header>
    <h1>Vault of Cardboard</h1>
    <input name="q" placeholder="i.e.: Ral color:RU +draw" autocomplete="off"
           v-model="search.query" @change="doSearch(search.query, true)" @keyup="forceSearch(search.query, true)">
    <nav>
      <li><a>Search</a>
        <nav>
          <li><a href="#!/docs">How do I search?</a></li>
          <li><a href="#!/sets">What sets are there?</a></li>
          <li class="separator"></li>
          <li v-if="session"><a href="#!/q/owned">My Collection</a></li>
          <li v-if="session"><a href="#!/q/own:2+">My Duplicates</a></li>
          <li v-if="session"><a href="#!/q/own:4+">My Playsets</a></li>
          <li v-if="session" class="separator"></li>
          <li><a href="#!/q/type:planeswalker">Planeswalkers</a></li>
          <li><a href="#!/q/=mythic">Mythics</a></li>
          <li><a href="#!/q/+gains? and +loses?">Life Gain + Loss</a></li>
          <li><a href="#!/q/type:land and +damage">Pain Lands</a></li>
          <li><a href="#!/q/usd:10+ and usd:400-">Expensive Cards</a></li>
        </nav></li>
      <li v-if="!session"><a href="#!/login" rel="login">Sign in</a></li>
      <li v-if="session"><a class="-username">{{ session.username }}</a>
        <nav>
          <li><a href="#!/timeline">My Collection</a></li>
          <li v-if="session.cohort == 'preview'"><a href="#!/decks">Decks</a></li>
          <li><a href="#!/logout" rel="logout">Sign out</a></li>
        </nav></li>
    </nav>
  </header>
  <div v-if="mode == 'search' && search.results.length > 0"
       class="colors" :style="colorBandStyle(search.results)"></div>
  <div id="main">
    <loading v-if="mode == 'loading'"></loading>
    <login
      v-else-if="mode == 'login'"
      :error="error"></login>
    <card-grid
      v-else-if="mode == 'search'"
      :q="search.query"
      :oops="search.error"
      :cards="search.results"></card-grid>
    <card-grid
      v-else-if="mode == 'draft'"
      :cards="draft"></card-grid>
    <timeline
      v-else-if="mode == 'timeline'"
      :transactions="transactions"></timeline>
    <set-list
      v-else-if="mode == 'sets'"
      :sets="sets"></set-list>
    <docs
      v-else-if="mode == 'docs'"
      :docs="docs"></docs>
    <changelog
      v-else-if="mode == 'changelog'"
      :changes="changes"></changelog>
    <div v-else class="landing">
      <div><img src="/img/front.png"></div>
      <div>
        <p>Whether you're putting together <a href="#!/q/type:sliver">that Sliver deck,</a>
        seeking out <a href="#!/q/type:legendary and type:creature">your next Commander,</a>
        or <a href="#!/q/Didgeridoo or type:Minotaur">just looking for some jank</a>,
        <em>Vault of Cardboard</em> has got you covered.</p>

        <p>With a <strong>powerful and flexible query language</strong> that lets you refine
        queries until you find <em>exactly</em> what you're looking for, and a
        <strong>buy / sell / trade</strong> model of <strong>collection management</strong>,
        you'll never again wonder what you have or what you need.</p>

        <copyright-footer></copyright-footer>
      </div>
    </div>
  </div>

  <div class="modal-bg" v-if="modal"></div>
  <card-detail
    v-if="modal"
    :card="modalfg.card"></card-detail>
</div>
`
});


String.prototype.reline = function (n,s) {
  var l = this.split(/\n/);
  if (s instanceof Array) { s = s.join("\n"); }
  l.splice(n-1,1,s);
  return l.join("\n");
}

function tparse(d) { // {{{
  if (typeof d == "string") {
    // because we insist on doing bad things with date formatting in the API...
    m = /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/.exec(d);
    if (!m) {
      console.log("'%s' doesn't look like a date/time string...", d);
      return ""
    }

    d = new Date();
    d.setTime(Date.UTC(parseInt(m[1]),   // year
                      parseInt(m[2])-1, // month
                      parseInt(m[3]),   // day
                      parseInt(m[4]),   // hour
                      parseInt(m[5]),   // minute
                      parseInt(m[6]))); // second
    return d;
  }

  if (!(d instanceof Date)) {
    var _d = new Date()
    if (!isNaN(d)) {
      _d.setTime(d * 1000);
    }
    return _d;
  }

  return d;
} // }}}

var $INDEX = {};

$(function () {
  function goto(sub) {
    return;
    if (sub.match(/^play(\/.*)?$/)) {
      var id = sub.replace(/.*play\//, '');

      $('#main').template('play');
      new TabletopAlpha(id, $('#main .play'));
      return;
    }

    if (sub.match(/^decks(\/.*)?$/)) {
      $.ajax({
        type: 'GET',
        url:  '/my/decks',
        success: function (data) {
          if (data.authn == 'required') {
            document.location.hash = '#!/login';
            return;
          }
          $('#main').template('decks', { decks: data });
        }
      });
      return;
    }
    if (sub.match(/^import\/deck$/)) {
      $('#main').template('import-deck');
      return;
    }

    if (sub.match(/^deck\/(.*)(\/.*)?$/)) {
      sub = sub.replace(/^deck\//, '');
      var id = decodeURIComponent(sub.replace(/\/.*/, ''));
      $.ajax({
        type: 'GET',
        url:  '/my/decks/'+id,
        success: function (data) {
          if (sub.match(/\/edit$/)) {
            $('#main').template('edit-deck', { deck: data });
          } else {
            $('#main').template('deck', { deck: data });
          }
        }
      });
      return;
    }
  }

  $(window).on('hashchange', function (event) {
    if (document.location.hash.match(/^#!/)) {
      UI.goto(document.location.hash.replace(/^#!\/?/, ''));
    }
  }).trigger('hashchange');

  $(document.body)
  .on('keyup', function (event) {
    if ($('.modal-fg').is(':visible')) {
      switch (event.key) {
      case 'ArrowDown':
      case 'ArrowUp':
        event.preventDefault();
        break;

      case 'ArrowLeft':
      case 'ArrowRight':
        $('.modal-bg, .modal-fg').hide();
        var id = $('.modal-fg .card.face [data-id]').attr('data-id'),
            who;

        if (event.key == 'ArrowRight') {
          var who = $('.results [data-id="'+id+'"]').closest('[data-own]').next();
          if (!who.length) {
            who = $('.results  [data-own]').first();
          }
        } else {
          who = $('.results [data-id="'+id+'"]').closest('[data-own]').prev();
          if (!who.length) {
            who = $('.results [data-own]').last();
          }
        }
        who[0].scrollIntoView();
        who.find('.face img').trigger('click');
        break;
      }
    }
  })
  .on('click',  'header > h1', function (event) {
    event.preventDefault();
    document.location.hash = '#!/';
    goto('');
  })
  .on('click',  'form a[rel=toggle-extra]', function (event) {
    event.preventDefault();
    $(event.target).closest('a').toggleClass('on').closest('form').find('.extra').fadeToggle();
  })
  .on('click', 'button[rel="new-buy"]', function (event) {
    event.preventDefault();
    document.location.hash = '#!/timeline/buy';
  })
  .on('click', 'button[rel="new-sell"]', function (event) {
    event.preventDefault();
    document.location.hash = '#!/timeline/sell';
  })
  .on('click', 'button[rel="new-deck"]', function (event) {
    document.location.hash = "#!/import-deck";
    event.preventDefault();
    $('#main').template("import-deck")
              .autofocus();
  })
  .on('click', 'button[rel="edit-deck"]', function (event) {
    event.preventDefault();
    document.location.hash = "#!/deck/"+($(event.target).closest('.deck').attr('data-id'))+"/edit";
  })
  .on('click', 'button[rel="playtest"]', function (event) {
    event.preventDefault();
    document.location.hash = "#!/play/"+($(event.target).closest('.deck').attr('data-uuid'));
  })
  .on('click', 'button[rel="delete-deck"]', function (event) {
    event.preventDefault();
    if (confirm("Are you sure you want to remove this deck?")) {
      $.ajax({
        type: 'DELETE',
        url:  '/my/decks/'+$(event.target).closest('.deck').attr('data-id'),
        success: function () { document.location.hash = "#!/decks/"+now(); }
      });
    }
  })
  .on('submit', 'form#buy, form#sell, form#import', function (event) {
    event.preventDefault();
    var $form = $(event.target);
    var $oops = $form.find('.oops');

    if (!$form.validate('reset').validate('validate')) {
      $oops.html('There were problems with this change to the collection...').show();
      return;
    }

    var $save = $form.find('button[data-in-progress]');
    $save.attr('data-original', $save.text())
         .text($save.attr('data-in-progress'))
         .addClass('in-progress');

    Clarifier.check($form.find('textarea.vif').val(), {
      update: function (vif) {
        $form.find('textarea.vif').val(vif);
      },

      failed: function (clarifier, error) {
        $save.removeClass('in-progress')
             .text($save.attr('data-original'));

        $oops.hide();

        if (clarifier) {
          $oops.html('There were some problems with your import').fadeIn();
          clarifier.mount($form.closest('div').find('.clarify'));

          if (clarifier.interactive()) {
            $form.find('button[type=submit]').hide();
          } else {
            $form.find('button[type=submit]').show();
          }

        } else {
          $oops.html(error).fadeIn();
        }
      },

      ok: function () {
        $('.clarify').empty().append('<div class="ok">Everything looks good!  Updating  your collection...</div>');

        var data = $form.serializeObject(true);
        data.occurred_at = data.occurred_at || strftime("%Y-%m-%d", new Date());

        var url = '/v1/collectors/'+$USER.uid+'/collections/_/transactions';
        $.ajax({
          type: (data.id ? 'PATCH'         : 'POST'),
          url:  (data.id ? url+'/'+data.id : url),
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function () {
            console.log('changes posted; redirecting to the timeline...');
            document.location.hash = '#!/timeline/'+now();
          }
        });
      }
    });
  })
  .on('submit', 'form#deck', function (event) {
    event.preventDefault();
    var $form = $(event.target);
    var $oops = $form.find('.oops');

    if (!$form.validate('reset').validate('validate')) {
      $oops.html('There were problems with this deck import...').show();
      return;
    }

    var $save = $form.find('button[data-in-progress]');
    $save.attr('data-original', $save.text())
         .text($save.attr('data-in-progress'))
         .addClass('in-progress');

    Clarifier.check($form.find('textarea.vif').val(), {
      update: function (vif) {
        $form.find('textarea.vif').val(vif);
      },

      failed: function (clarifier, error) {
        $save.removeClass('in-progress')
             .text($save.attr('data-original'));

        $oops.hide();
        if (clarifier) {
          $oops.html('There were some problems with your import').fadeIn();
          clarifier.mount($form.closest('div').find('.clarify'));

          if (clarifier.interactive()) {
            $form.find('button[type=submit]').hide();
          } else {
            $form.find('button[type=submit]').show();
          }

        } else {
          $oops.html(error).fadeIn();
        }
      },

      ok: function () {
        $('.clarify').empty().append('<div class="ok">Everything looks good!  Importing your deck...</div>');

        var data = $form.serializeObject();
        $.ajax({
          type: (data.id ? 'PUT'                : 'POST'),
          url:  (data.id ? '/my/decks/'+data.id : '/my/decks'),
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function () {
            console.log('changes posted; redirecting to the deck list...');
            document.location.hash = '#!/decks/'+now();
          }
        });
      }
    });
  })
  .on('click', '.face a[rel=flip]', function (event) {
    event.preventDefault();
    var $card = $(event.target).closest('.face');
    var $img  = $(event.target).closest('.face').find('img');

    if ($card.is('.transform') || $card.is('.double_faced_token')) {
      var src = $img.attr('src');
      $img.attr('src', $img.attr('data-flip-src'));
      $img.attr('data-flip-src', src);

    } else if ($card.is('.flip')) {
      $img.toggleClass('flipped');
    }
  })
  .on('click', '.results .face img', function (event) {
    var id = $(event.target).closest('[data-id]').attr('data-id');
    UI.modalfg = { card: UI.vault.card(id) };
    UI.modal = true;
  })
  .on('click', '.oops ul a[href="#more"]', function (event) {
    event.preventDefault();
    $(event.target).closest('ul').find('li.suppress').show();
    $(event.target).closest('li').hide();
  })
  .on('click', '.modal-fg a.close', function (event) {
    event.preventDefault();
    UI.modal = false;
  })
});
</script>
</body>
</html>
