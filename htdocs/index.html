<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,intial-scale=1">
<title>Vault of Cardboard</title>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="stylesheet" type="text/css" href="/css/vcb.css" />
</head>
<body>
<div id="app"></div>

<script type="text/html" id="template:play-card"><!-- {{{ -->
  <img class="c" id="[[= _.id ]]" src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.image ]]"
       [[ if (_.card.layout == 'transform') { ]]data-flip-src="[[= $CONFIG.imgroot ]]/cards/[[= _.card.back ]]"[[ } ]]
       draggable="true"
       alt="[[= _.card.name ]]" title="[[= _.card.name ]]">
</script><!-- }}} -->
<script type="text/html" id="template:play"><!-- {{{ -->
  <div class="play">
    <div class="wash"></div>
    <div class="draw strip"><div class="cards"></div></div>
    <div class="board">
      <div class="zones">
        <div class="empty command zone"  ><img class="placeholder" src="/play/command-zone.png"></div>
        <div class="empty exile zone"    ><img class="placeholder" src="/play/exile.png"><ul><li><a href="#" rel="search">search</a></li><li></ul></div>
        <div class="library"><img class="placeholder" src="/play/library.png"><img class="back" src="/img/mtgback.jpg"><ul><li><a href="#" rel="draw">draw</a></li><li><a href="#" rel="search">search</a></li><li><a href="#" rel="exile">exile</a></li></ul></div>
        <div class="empty graveyard zone"><img class="placeholder" src="/play/graveyard.png"><ul><li><a href="#" rel="search">search</a></li><li><a href="#" rel="exile">exile</a></li></ul></div>
      </div>
      <div class="battlefield"></div>
      <div class="inspect">
        <img>
        <div class="h2h">
          <div class="p ap">
            <h2>
              K-A-A-L-I-A Kaaaaaaaalia!
              <span class="active">AP</span>
            </h2>
            <div class="stats">
              <div class="details">
                <p>Ima throw down some angels and demons, mmkay?</p>
                <span class="colors">[[= cardboard.colorize('WUB') ]]</span>

                <div class="poison gauge">
                  <span class="n">9</span>
                  <div class="fill"></div>
                  <label>poison<label>
                </div>

                <div class="commander-damage gauge">
                  <span class="n">19</span>
                  <div class="fill"></div>
                  <label>Silver Queen<label>
                </div>
                <div class="commander-damage gauge">
                  <span class="n">4</span>
                  <div class="fill"></div>
                  <label>Muldrotha<label>
                </div>
                <div class="commander-damage gauge">
                  <span class="n">2</span>
                  <div class="fill"></div>
                  <label>Niv-Mizzet<label>
                </div>
              </div>
              <div class="side">
                <div class="life total">
                  <span>20</span>
                  <label>Life</label>
                </div>

                <div class="energy counters">
                  <span>5</span>
                  <label>energy</label>
                </div>

                <div class="xp counters">
                  <span>1</span>
                  <label>xp</label>
                </div>
              </div>
            </div>
          </div>
          <!--
          <div class="sep"><span>vs</span></div>
          <div class="p nap">
            <h2>
              <span class="ap">AP</span>
              <span class="nap">NAP</span>
              What Even Are Slivers, Anyway?
              <span class="colors">[[= cardboard.colorize('C') ]]</span>
            </h2>
            <ul class="stats">
              <li class="life">20</li>
            </ul>
          </div>
          -->
        </div>
      </div>
    </div>
    <div class="hand"></div>
  </div>
</script><!-- }}} -->
<script type="text/html" id="template:play-draw"><!-- {{{ -->
  <div class="cards">
    [[ for (var i = 0; i < _.cards.length; i++) { ]]
      [[ include('play-card', _.cards[i]); ]]
    [[ } ]]
    [[ if (_.mode == 'draw') { ]]
      <img src="/img/mtgback.jpg">
    [[ } ]]
    <ul class="button">
      [[ if (_.mode == 'draw') { ]]
      <li><a href="#" rel="put-in-hand">ok</a></li>
      [[ } ]]
    </ul>
  </div>
</script><!-- }}} -->

<script type="text/javascript">
  var $CONFIG = {
    imgroot: "//vault-of-cardboard.s3.amazonaws.com"
  };
</script>
<script src="https://vuejs.org/js/vue.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/play.js"></script>
<script type="text/javascript" src="/js/cardboard.min.js"></script>
<script type="text/javascript">
Vue.component('copyright-footer', {
  data() { return {}; },
  template: `
<footer>
  Magic: The Gathering is a Trademark of Wizards of the Coast, Inc. and Hasbro, Inc.<br/>
  Vault of Cardboard is Copyright &copy; 2020 <a href="https://jameshunt.us">James Hunt</a>
</footer>
`
});

Vue.component('loading', {
  data() {
    return {
      quotes: [
        /* flavor:canto or flavor:"Song" */
        /* Arbor Armament (DOM) */
        "<blockquote>&ldquo;Llanowar's boughs are ever ready<br>To unleash an autumn of steel leaves.&rdquo;<cite>&mdash;&ldquo;Song of Freyalise&rdquo;</cite></blockquote>",

        /* Blinding Light (MIR) */
        "<blockquote>&ldquo;My shield will bear a shining sun so you will always be with me. / Inlaid with gold, it will shine like glowing embers.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Chariot of the Sun (MIR) */
        "<blockquote>&ldquo;Sun follows Moon until she tires, then carries her until she's strong / and runs ahead of him again.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Congregate (A25) */
        "<blockquote>&ldquo;In the gathering there is strength for all who founder, renewal for all who languish, love for all who sing.&rdquo;<cite>&mdash;Song of All, canto 642</cite></blockquote>",

        /* Defensive Formation (USG) */
        "<blockquote>&ldquo;Your enemies will pound upon the door of your defenses, but only you shall have the key, and it is the key of life.&rdquo;<cite>&mdash;Song of All, canto 873</cite></blockquote>",

        /* Disenchant (A25) */
        "<blockquote>&ldquo;The tools of evil are mere things. And like all things, they cannot last forever.&rdquo;<cite>&mdash;Song of All, canto 881</cite></blockquote>",

        /* Early Harvest (MIR) */
        "<blockquote>&ldquo;Tonight we'll eat a farewell feast. Cold corn porridge is not enough. / Let's peel papayas, pineapples, and mangoes, drink coconut milk, / and bake bananas.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Femeref Knight (MIR) */
        "<blockquote>&ldquo;I will return / with lizard skins for your sandals. Paint your eyes black and wait for me.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Flare (MIR) */
        "<blockquote>&ldquo;In the forest, fires light the sky as black clouds unfold their weight.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Invoke the Divine (DOM) */
        "<blockquote>&ldquo;Let go of all that harms you. Cast your burdens into the darkness, and build for the faithful a house of light.&rdquo;<cite>&mdash;Song of All, canto 1008</cite></blockquote>",

        /* Kukemssa Pirates (MIR) */
        "<blockquote>&ldquo;. . . pirates gambled with a djinn and lost the thing more dear than gold.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* On Serra's Wings (DOM) */
        "<blockquote>&ldquo;The spirit of Serra raised Brindri high and commanded her to keep the balance.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

        /* Pegasus Charger (USG) */
        "<blockquote>&ldquo;The clouds came alive and dove to the earth! Hooves flashed among the dark army, who fled before the spectacle of fury.&rdquo;<cite>&mdash;Song of All, canto 211</cite></blockquote>",

        /* Planar Birth (USG) */
        "<blockquote>&ldquo;From womb of nothingness sprang this place of beauty, purity, and hope realized.&rdquo;<cite>&mdash;Song of All, canto 3</cite></blockquote>",

        /* Sacred Mesa (MIR) */
        "<blockquote>&ldquo;Do not go there, do not go / unless you rise on wings, unless you walk on hooves.&rdquo;<cite>&mdash;&ldquo;Song to the Sun,&rdquo; Femeref song</cite></blockquote>",

        /* Serra Avenger (TSP) */
        "<blockquote>&ldquo;Those who endure in the face of suffering, those whose faith shines long in evil days, they shall see salvation.&rdquo;<cite>&mdash;Song of All, canto 904</cite></blockquote>",

        /* Serra's Embrace (USG) */
        "<blockquote>&ldquo;Lifted beyond herself, for that battle Brindri was an angel of light and fury.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

        /* Unfulfilled Desires (MIR) */
        "<blockquote>&ldquo;Like Day from Night, / I'll live my life apart from you, just glimpsing you across the sky, / because you cannot change, my dear, and nor can I.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Village Elder (MIR) */
        "<blockquote>&ldquo;Enchant me with your tale-telling. Tell about Tree, Grass, River, and Wind. / Tell why Truth must fight with Falsehood, and why Truth will always win.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Voice of Grace (USG) */
        "<blockquote>&ldquo;Opposite Law is Grace, and Grace must be preserved. If the strands of Grace are unraveled, its design will be lost, and the people with it.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

        /* Voice of Law (USG) */
        "<blockquote>&ldquo;Life's balance is as a star: on one point is Law, and Law must be upheld. If the knots of order are loosened, chaos will spill through.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

        /* Wild Elephant (MIR) */
        "<blockquote>&ldquo;I will tell my father's stories . . . . How the elephants trampled the leopard cub, and its father, though he knew, killed nine goats instead.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Wildgrowth Walker (XLN) */
        "<blockquote>&ldquo;Hear me, stone, root, branch: be the fist of this land. Turn back those who trample upon your domain.&rdquo;<cite>&mdash;Song of the Shaper</cite></blockquote>",

        /* Zebra Unicorn (MIR) */
        "<blockquote>&ldquo;I'll capture gentle zebras / for your steeds and fill the stable with every kind of unicorn.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

        /* Zhalfirin Knight (MIR) */
        "<blockquote>&ldquo;You returned a warrior. . . . Your hair was cut, your eye tattooed with the red triangle of war.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>"
      ],
      current: 0,
      next:    1,
    };
  },
  mounted() {
    window.setInterval(() => { this.advance(); }, 7700);
    this.next = parseInt(Math.random() * this.quotes.length);
    this.advance();
  },
  methods: {
    advance() {
      this.current = this.next;
      this.next = parseInt(Math.random() * (this.quotes.length - 1));
      if (this.next >= this.current) {
        this.next++;
      }
    }
  },
  template: `
<div id="loading">
  <h1>Loading...</h1>
  <p class="marquee" v-html="quotes[current]"></p>
</div>
`
});

Vue.component('login', {
  data() {
    return {
      error: undefined,
      username: '',
      password: ''
    };
  },
  mounted() {
    $('[name=username]').focus();
  },
  methods: {
    colorize: cardboard.colorize,
    authenticate(username, password) {
      event.preventDefault();
      cardboard.API.authenticate(username, password).then(data => {
        if (data.authenticated) {
          UI.session = data.authenticated;
          UI.vault.unload_collection();
          cardboard.When.trigger('authenticated');

          document.cookie = 'vcb_sesh='+UI.session.session+';max-age=7776000;samesite=strict';
          cardboard.API.fetch_collection_for(UI.session.uid)
            .then(c => cardboard.When(cardboard.CardsLoaded, () => {
              UI.vault.load_collection(c.base, c.patches);
            }));
          UI.browse('/q/owned');

        } else {
          this.error = data.response.message;
        }
      });
    }
  },
  template: `
<div class="landing login">
  <div><img src="/img/front.png"></div>
  <div>
    <p>Whether you're putting together <a href="#!/q/type:sliver">that Sliver deck,</a>
    seeking out <a href="#!/q/type:legendary and type:creature">your next Commander,</a>
    or <a href="#!/q/Didgeridoo or type:Minotaur">just looking for some jank</a>,
    <em>Vault of Cardboard</em> has got you covered.</p>

    <form class="user" @submit="authenticate(username, password)">
      <h2>Sign In</h2>
      <p class="divert">New to Vault of Cardboard?  <a href="#!/signup">sign up today</a>!</p>

      <div class="oops" v-if="error == 'authentication-failed'">
        Invalid username or password.
      </div>
      <div class="oops" v-else-if="error">
        Uh-oh, something broke pretty bad.  Tap <span v-html="colorize('2UUU')"></span> and summon James, Fixer of Codes!
      </div>
      <div class="control">
        <label>Username</label>
        <input type="text" name="username" autocomplete="off" v-model="username">
      </div>
      <div class="control">
        <label>Password</label>
        <input type="password" name="password" v-model="password">
      </div>
      <button type="submit"class="default safe">Sign in</button>
    </form>
    <copyright-footer></copyright-footer>
  </div>
</div>
`
});

Vue.component('signup', {
  data() {
    return {
      error:    undefined,
      username: '',
      email:    '',
      password: ''
    };
  },
  mounted() {
    $('[name=username]').focus();
  },
  methods: {
    colorize: cardboard.colorize,
    signup() {
      event.preventDefault();
      cardboard.API.signup(this.username, this.email, this.password)
        .then(data => {
          if (data.authenticated) {
            UI.session = data.authenticated;
            UI.vault.unload_collection();
            cardboard.When.trigger('authenticated');

            document.cookie = 'vcb_sesh='+UI.session.session+';max-age=7776000;samesite=strict';
            cardboard.API.fetch_collection_for(UI.session.uid)
              .then(c => cardboard.When(cardboard.CardsLoaded, () => {
                UI.vault.load_collection(c.base, c.patches);
              }));
            UI.browse('/q/owned');

          } else {
            this.error = data.response.message;
          }
        });
    }
  },
  template: `
<div class="landing login">
  <div><img src="/img/front.png"></div>
  <div>
    <p>Whether you're putting together <a href="#!/q/type:sliver">that Sliver deck,</a>
    seeking out <a href="#!/q/type:legendary and type:creature">your next Commander,</a>
    or <a href="#!/q/Didgeridoo or type:Minotaur">just looking for some jank</a>,
    <em>Vault of Cardboard</em> has got you covered.</p>

    <form class="user" @submit="signup()">
      <h2>Sign Up Today!</h2>
      <p class="divert">Already a proud Vaulter?  <a href="#!/login">sign in</a>!</p>

      <div class="oops" v-if="error == 'username-too-short'">
        The username you picked is too short.  Username really ought to be at least four (4) characters long.
      </div>
      <div class="oops" v-else-if="error == 'invalid-email'">
        Your email address doesn't look quite right; it should have an at sign ('@') and at least one dot ('.')...
      </div>
      <div class="oops" v-else-if="error == 'password-too-short'">
        The password you chose is too short; try for at least eight (8) characters, or use a password manager.
      </div>
      <div class="oops" v-else-if="error">
        Uh-oh, something broke pretty bad.</br>Pay <span v-html="colorize('2UUU')"></span> and summon James, Fixer of Codes!
      </div>
      <div class="control">
        <label>Username</label>
        <input type="text" name="username" autocomplete="off" v-model="username"
               placeholder="Pick a memorable username">
      </div>
      <div class="control">
        <label>Email</label>
        <input type="text" name="email" autocomplete="off" v-model="email"
               placeholder="We'll never spam you or sell you">
      </div>
      <div class="control">
        <label>Password</label>
        <input type="password" name="password" v-model="password"
               placeholder="Make it secret.  Make it secure.">
      </div>
      <button type="submit"class="default safe">Sign up!</button>
    </form>
    <copyright-footer></copyright-footer>
  </div>
</div>
`
});

Vue.component('changelog', {
  props: ['changes'],
  mounted() {
    // FIXME this is a bit wonky right now, but it works.
    let id = document.location.hash;
    if (id.match(/^#!\/changelog\//)) {
      let $target = $('h2[id="'+id.replace(/^#/,'')+'"]');
      if ($target.length != 0) {
        $('html, body').animate({ scrollTop: $target.offset().top }, 200);
      }
    }
  },
  template: `
<div class="docs changelog prose">
  <template v-for="change in changes">
    <h2 :id="'!/changelog/' + change.release">
      <img :src="change.header">
      {{ change.title }}
      <a :href="'/#!/changelog/' + change.release">(permalink)</a>
      <span>{{ change.dated }}</span>
    </h2>
    <p v-html="change.notes"></p>
  </template>
</div>
`
});

Vue.component('docs', {
  props: ['docs'],
  template: `
<div class="docs prose">
  <div v-html="docs"></div>
</div>
`
});

Vue.component('set-list', {
  props: ['sets'],
  mounted() {
    $('#main table.sortable').sortableTable();
  },
  methods: {
    dated:    dated,
    strftime: strftime,
  },
  template: `
<div class="sets prose">
  <h1>Currently Known Magic: the Gathering Sets</h1>
  <p>These are all the M:tG sets that Vault of Cardboard knows about.
  Most of these should have images.  If a set is missing, or missing its images,
  please let us know!</p>
  <table class="sets sortable listing">
    <thead><tr>
      <th></th>
      <th class="sortable">Code</th>
      <th class="sortable">Name</th>
      <th class="sortable" data-sort-as="number">Release Date</th>
      <th class="sortable" data-sort-as="number">Size</th>
      <th></th>
    </tr></thead>
    <tbody>
      <tr v-for="set in sets"
          :key="set.code"
          :set="set">
        <td><span :class="'ss ss-' + set.code.toLowerCase()"></span></td>
        <td>{{ set.code }}</td>
        <td>{{ set.name }}</td>
        <td :data-sort="set.release">{{ strftime("%B %Oe, %Y", dated(set.release)) }}</td>
        <td :data-sort="set.size"><a :href="'#!/q/set:' + set.code">{{ set.size }}</a></td>
      </tr>
    </tbody>
  </table>
</div>
`
})

Vue.component('deck-list', {
  props: ['decks'],
  data: function () {
    return {
      mode: 'view',
    }
  },
  mounted() {
    $('#main table.sortable').sortableTable();
  },
  methods: {
    dated:    dated,
    strftime: strftime,

    start_new_deck() {
      event.preventDefault();
      this.mode = 'new';
    },

    show_deck(deck) {
      UI.deck = deck;
      UI.redraw('deck');
    },

    create_deck(ev) {
      this.decks.push(ev.deck);
      this.mode = 'view';
    },

    update_deck(ev) {
      for (var i = 0; i < this.decks.length; i++) {
        if (this.decks[i].id == ev.deck.id) {
          Object.assign(this.decks[i], ev.deck);
          break;
        }
      }
      this.mode = 'view';
    },

    delete_deck(id) {
      for (var i = 0; i < this.decks.length; i++) {
        if (this.decks[i].id == id) {
          this.decks.splice(i, 1);
          break;
        }
      }
      this.mode = 'view';
    },

  },
  template: `
<div class="decks prose">
  <h1>Your Magic: the Gathering Decks</h1>
  <div class="buttons" v-if="mode == 'view'">
    <button class="action" @click="start_new_deck()">Craft New Deck</button>
  </div>
  <deck-form
    v-else
    @created-deck="create_deck($event)"
    mode="new"></deck-form>

  <table class="decks sortable listing">
    <thead><tr>
      <th class="sortable">Code</th>
      <th class="sortable">Name</th>
      <th class="sortable" data-sort-as="number">Created</th>
      <th class="sortable" data-sort-as="number">Last Updated</th>
    </tr></thead>
    <tbody>
      <tr v-for="deck in decks" :key="deck.id">
        <td><a href="#" @click="show_deck(deck)">{{ deck.code }}</a></td>
        <td><a href="#" @click="show_deck(deck)">{{ deck.title }}</a></td>
        <td :data-sort="deck.created_at">{{ strftime("%B %Oe, %Y", dated(deck.created_at)) }}</td>
        <td :data-sort="deck.updated_at">{{ strftime("%B %Oe, %Y", dated(deck.updated_at)) }}</td>
      </tr>
    </tbody>
  </table>
</div>
`
})

Vue.component('deck-form', {
  props: {
    mode: String,
    deck: {
      type: Object,
      default: function() {
        return {
          title:       '',
          code:        '',
          description: '',
          main:        '',
          side:        '',
          maybe:       ''
        };
      }
    }
  },
  data() {
    return {
      problems: []
    };
  },
  methods: {
    save() {
      event.preventDefault();

      if (this.deck.id) {
        cardboard.API.patch_deck(UI.session, this.deck)
          .then(data => this.$emit('updated-deck', data));

      } else {
        cardboard.API.post_deck(UI.session, this.deck)
          .then(data => this.$emit('created-deck', data));
      }
    },
    remove() {
      event.preventDefault();

      cardboard.API.delete_deck(UI.session, this.deck.id)
        .then(data => this.$emit('deleted-deck', this.deck.id));
    },

    validate() {
      this.problems = cardboard.CDIF.validate(this.deck.main, UI.vault, 1);
    },

    clarified($event) {
      let lines = this.deck.main.split("\n");
      lines.splice($event.problem.line - 1, 1, $event.replacements.map(r => r[0]+'x '+r[1]));
      this.deck.main = lines.join("\n");

      this.validate();
    }
  },
  template: `
<form :class="'deck data-entry ' + mode" @submit="save()">
  <h2 v-if="mode == 'new'">Craft a New Deck</h2>
  <h2 v-else="mode == 'edit'">Update &ldquo;{{ deck.title }}&rdquo;</h2>
  <div class="band">
    <div>
      <div class="control">
        <label for="code">Internal Identifier</label>
         <input type="text" name="code" v-model="deck.code"
                class="autofocus"
                placeholder="A unique ID to use with 'in:...' queries"
                data-validate="present;min=2;max=40"
                data-error-if-missing="Please provide an internal identifier, for use in querying the contents of this deck."
                data-error-out-of-bounds="Identifiers must be between 2 and 40 characters long."
                autocomplete="off">

      </div>
    </div>
  </div>

  <div class="band">
    <div>
      <div class="control">
        <label for="title">Title of Deck</label>
        <input type="text" name="title" v-model="deck.title"
               class="autofocus"
               placeholder="A name for this deck, which will be displayed to others."
               data-validate="present;min=2"
               data-error-if-missing="Please provide a name for this deck."
               data-error-out-of-bounds="Deck names must be at least two characters long."
               autocomplete="off">
      </div>
    </div>
  </div>

  <div class="band">
    <div>
      <div class="control">
        <label for="description">Description / Notes</label>
        <textarea name="description" v-model="deck.description"
                  placeholder="(feel free to expound on the premise and power of your deck...)"
                  data-validate="max=2000"></textarea>
      </div>
    </div>
  </div>

  <div class="band">
    <div>
      <div class="control">
        <label for="main">Maindeck</label>
        <textarea name="main" v-model="deck.main"
                  @blur="validate()"
                  class="cdif"
                  data-validate="present;max=100k"></textarea>
      </div>
      <gainloss-status :status="status()"></gainloss-status>
    </div>
    <div>
      <div class="help no-frills">
        <p>VIF format is designed to be simple.<br>
           First, specify how many cards are gained or lost:</p>
        <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then, what set the printed cards are from:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then the full card oracle name:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
      </div>
    </div>
  </div>
  <clarifier v-for="problem in problems" :key="problem.id"
             @clarified="clarified($event)"
             :problem="problem"></clarifier>

  <div v-if="problems.length == 0">
    <button class="default safe" type="submit">{{ mode == 'new' ? "Create" : "Update" }} Deck</button>
    <button v-if="mode == 'edit'" @click="remove()" class="danger">Delete This Deck</button>
  </div>
</form>
`
});

Vue.component('deck', {
  props: ['deck'],
  data: function () {
    return {
      imgroot: $CONFIG.imgroot,
      sleeve: 'n',
      shuffled: undefined,
      mode:     'view',
    }
  },
  computed: {
    cards() {
      return UI.vault.resolve(this.deck.main);
    },

    curve() {
      let min = undefined,
          max = 0;
      let curve = [];

      UI.vault.filter(this.cards.map(c => c.card), '!type:land and !type:token').forEach(card => {
        if (!(card.cmc in curve)) {
          curve[card.cmc] = [];
        }
        curve[card.cmc].push(card);
        if (card.cmc > max) { max = card.cmc; }
        if (typeof(min) === 'undefined' || card.cmc < min) { min = card.cmc; }
      });

      for (let i = 0; min && i < min; i++) {
        curve[i] = [];
      }
      return curve;
    },

    showcase() {
      let included = cardboard.Query.parse('!type:land and !type:token');
      let lib = [];
      this.cards.forEach(c => {
        if (included.match(c.card)) {
          lib.push(c);
        }
      });
      return lib.slice(0,3);
    },

    library() {
      let included = cardboard.Query.parse('!type:token');
      let lib = [];
      this.cards.forEach(c => {
        if (included.match(c.card)) {
          lib.push(c);
        }
      });
      return cardboard.shuffle(lib);
    },

    sample_hand() {
      return this.library.slice(0,7);
    },
  },
  methods: {
    next_draws(n) {
      return this.library.slice(8,n+8);
    },

    sleeve_it(sl) {
      this.sleeve = sl;
    },

    shuffle() {
      event.preventDefault();
      this.deck.main = this.deck.main + '\n';
    },

    update_deck(ev) {
      this.deck = ev.deck;
      this.mode = 'view';
    }
  },
  template: `
<div class="deck prose">
  <template v-if="mode == 'view'">
    <div class="title">
      <span v-if="deck.code">in:{{ deck.code }}</span>
      <h1>{{ deck.title }}</h1>
    </div>
    <div class="heads-up">
      <div>
        <template v-if="deck.notes" v-html="deck.notes"></template>
        <template v-else><em>This deck's builder wishes for it to remain a mystery...</em></template>
        <button class="action" rel="play">Play!</button>
      </div>
      <div>
        <div class="showcase">
          <card v-for="c in showcase" :sleeve="sleeve" :card="c.card" :key="c.id"></card>
        </div>
        <ul :class="'sleeview sl-'+sleeve">
          <li class="sl-w" @click="sleeve_it('w')">snow</li>
          <li class="sl-u" @click="sleeve_it('u')">azure</li>
          <li class="sl-b" @click="sleeve_it('b')">slate</li>
          <li class="sl-r" @click="sleeve_it('r')">crimson</li>
          <li class="sl-g" @click="sleeve_it('g')">emerald</li>
        </ul>
      </div>
    </div>

    <h2>Sample Hand <a href="#" @click="shuffle()" rel="shuffle">‚Üª</a></h2>
    <div class="hand"><card-grid :sleeve="sleeve" :actual="true" :cards="sample_hand"></card-grid></div>

    <h2>Next 16 Draws <a href="#" @click="shuffle()" rel="shuffle">‚Üª</a></h2>
    <div class="hand"><card-grid :sleeve="sleeve" :actual="true" :cards="next_draws(16)"></card-grid></div>

    <h2>Mana Curve</h2>
    <div class="curve">
      <div v-for="(stack, cmc) in curve">
        <ul>
          <li v-for="card in stack">
             <img :src="imgroot + '/cards/' + card.image"
                  :alt="card.name + ' [' + card.set.code + ']'"
                  :title="card.name + ' [' + card.set.code + ']'"></li>
          <li><img src="/img/mtgback.jpg"></li>
        </ul>
        <p>{{ cmc }}</p>
      </div>
    </div>

    <h2>What's In It?</h2>
    <div class="buttons">
      <button class="action" @click="mode = 'edit'">Edit</button>
    </div>
    <pre class="rawlist"><code>{{ deck.main }}</code></pre>

  </template>
  <deck-form
    v-else
    mode="edit"
    @updated-deck="update_deck($event)"
    :deck="deck"></deck-form>
</div>
`
});

Vue.component('card-grid', {
  props: ['q', 'found', 'more', 'oops', 'cards', 'actual', 'sleeve'],
  template: `
<div class="search">
  <div v-if="oops" class="oops">{{ q }}: {{ oops }}</div>
  <div v-if="q" class="meta-results">found <span class="count">{{ found }}</span> card{{ cards.length == 1 ? '' : 's' }}.</div>
  <div class="results grid" v-if="actual">
    <card v-for="c in cards" :key="c.id"
          :sleeve="sleeve" :card="c.card"></card>
  </div>
  <div class="results grid" v-else>
    <card v-for="card in cards" :key="card.id"
          :backed="card.owned > 0" :sleeve="sleeve" :card="card"></card>
  </div>
  <div class="note meta-results" v-if="more">Not all {{ found }} matching cards displayed.  Have you tried narrowing your search criteria?</div>
</div>
`
});

Vue.component('card', {
  props: ['card', 'backed', 'sleeve'],
  data() {
    return {
      imgroot: $CONFIG.imgroot,
    };
  },
  template: `
<span :class="'card ' + (sleeve ? ('sleeved sl-'+sleeve) : '')">
  <span v-if="backed" class="back"><span><img src="/img/mtgback.jpg"></span></span>
  <span :class="'face ' + card.layout">
    <span><a v-if="card.layout == 'transform'" href="#" rel="flip"></a>
    <img :data-id="card.id" :src="imgroot + '/cards/' + card.image"
         :alt="card.name + ' [' + card.set.code + ']'"
         :title="card.name + ' [' + card.set.code + ']'"
         :data-flip-src="imgroot + '/cards/' + card.back"></span>
  </span>
</span>
`
});

Vue.component('card-detail', {
  props: ['card'],
  data() {
    return {
      imgroot: $CONFIG.imgroot,
    };
  },
  methods: {
    colorize: cardboard.colorize,
    price(d) {
      if (typeof(d) === 'undefined' || d == '') {
        return '';
      }
      return '$'+parseFloat(d).toFixed(2).split('').reverse().join('').match(/.{1,3}/g).join(',').split('').reverse().join('').replace(/,\./, '.');
    },
    oracles(card) {
      return cardboard.symbolize(card.oracle.replace('//', "\n<hr>\n")).split(/\n+/);
    }
  },
  template: `
<div class="modal-fg card-detail">
  <div>
    <div>
      <card :card="card"></card>
    </div>
    <div class="detail">
      <a class="close" href="#">X</a>
      <ul class="info">
        <li><strong>{{ card.name }}</strong></li>
        <li><em>{{ card.type }}</em></li>
        <li>{{ card.set.name }} ({{ card.set.code }})</li>
        <li>#{{ card.number }}/{{ card.set.total }}</li>
        <li v-html="colorize(card.color)"></li>
        <li><strong>CMC:</strong> {{ card.cmc }}</li>
        <li>{{ card.rarity }}</li>
      </ul>
      <ul class="owned">
        <li><strong>Owned:</strong> {{ card.owned }}</li>
      </ul>
      <ul>
        <li class="oracle"><p v-for="(line, i) in oracles(card)" :key="i" v-html="line"></p></li>
      </ul>
      <p v-if="card.price" class="price">
        {{ price(card.price) }}
        <span v-if="card.price > 999" class="w1">remember kids, M:tG is <strong>NOT</strong> an investment...</span>
        <span v-else-if="card.price > 99" class="w2">oof</span>
        <span v-else-if="card.price > 9" class="w3">that's a bit much, don't you think?</span>
      </p>
    </div>
  </div>
</div>
`
});

Vue.component('timeline', {
  props: ['transactions'],
  data: function () {
    return {
      target: '',
      mode: 'view',

      import_txn: {
        summary: 'Collection Import',
        dated:   (new Date()).toISOString().slice(0,10),
        notes:   '',
        disposition: 'buy',
        gain:    '',
        loss:    ''
      }
    };
  },
  computed: {
    total_cards() {
      let v = 0;
      this.transactions.forEach(t => {
        v += t.total_card_gain  - t.total_card_loss;
      });
      return v;
    },
    total_unique_cards() {
      let v = 0;
      this.transactions.forEach(t => {
        v += t.unique_card_gain - t.unique_card_loss;
      });
      return v;
    },

    monthly_bands() {
      let by_date = new Map();

      this.transactions.forEach(t => {
        t.total_delta  = t.total_card_gain  - t.total_card_loss;
        t.unique_delta = t.unique_card_gain - t.unique_card_loss;

        t.type = ((gained, lost) => {
          if (gained && lost) { return 'trade'; }
          if (gained)         { return 'buy';   }
          if (lost)           { return 'sell';   }
          return 'no-op';
        })(t.total_card_gain > 0, t.total_card_loss > 0);

        var d = t.dated;
        d = d ? parseInt(d.replace(/-/g, '')) : undefined;
        t._dated = d;
        d = d ? (100 * parseInt(d / 100) + 5).toString() : '0';

        if (!by_date.has(d)) {
          by_date.set(d, {
            total_delta:  0,
            unique_delta: 0,
            transactions: []
          });
        }
        let x = by_date.get(d);
        x.transactions.push(t);
        x.total_delta  += t.total_delta;
        x.unique_delta += t.unique_delta;
        by_date.set(d, x);
      });

      let to_sort = [];
      by_date.forEach((band, d) => {
        band.transactions.sort((a, b) => { return b._dated - a._dated; });
        to_sort.push([d, band]);
      });

      return to_sort.sort((a, b) => { return b[0] - a[0]; });
    }
  },

  methods: {
    start_new_transaction() {
      event.preventDefault();
      this.mode = 'new';
    },

    start_edit_transaction(id) {
      event.preventDefault();
      this.target = id;
      this.mode = 'edit';
    },

    create_transaction(ev) {
      this.transactions.push(ev.transaction);
      this.mode = 'view';
    },

    update_transaction(ev) {
      for (var i = 0; i < this.transactions.length; i++) {
        if (this.transactions[i].id == ev.transaction.id) {
          Object.assign(this.transactions[i], ev.transaction);
          break;
        }
      }
      this.mode = 'view';
    },

    delete_transaction(id) {
      for (var i = 0; i < this.transactions.length; i++) {
        if (this.transactions[i].id == id) {
          this.transactions.splice(i, 1);
          break;
        }
      }
      this.mode = 'view';
    },

    gainloss(n) {
      return n < 0 ? 'loss' : n > 0 ? 'gain' : '';
    },

    heading(d) {
      return parseInt(d) ? strftime("%B %Y", dated(d)) : "The Beginning";
    }
  },
  template: `
<div class="prose">
  <template v-if="transactions.length == 0">
    <h1>Let's Get You A <em>Collection</em>...</h1>
    <p>We don't have a clue what's in your collection.<br>
       Why don't we fix that, and get to know one another better?</p>

    <transaction-form
      @created-transaction="create_transaction($event)"
      mode="import"
      :transaction="import_txn"></transaction-form>
  </template>
  <template v-else>
    <h1>Your Magic Collection <em>Through Time!</em></h1>
    <div class="timeline">
      <div class="now summary">
        <h2>Today</h2>
        <ul>
          <li><em>{{ total_cards }}</em> cards (<em>{{ total_unique_cards }}</em> unique)</li>
        </ul>

        <div class="buttons" v-if="mode != 'new'">
          <button class="action" rel="new-buy" @click="start_new_transaction()">Buy / Sell / Trade</button>
        </div>
        <transaction-form
          v-else
          @created-transaction="create_transaction($event)"
          mode="new"></transaction-form>
      </div>

      <div v-for="d in monthly_bands" class="aggr">
        <h2>{{ heading(d[0]) }} <span :class="gainloss(d[1].total_delta)">{{ d[1].total_delta }} cards <span :class="gainloss(d[1].unique_delta)">({{ d[1].unique_delta }} unique)</span></span></h2>
        <ul>
          <li v-for="txn in d[1].transactions" :class="txn.type">
            <em :class="gainloss(txn.total_delta)">{{ txn.total_delta }}</em> cards in {{ txn.dated }} {{ txn.type }} <strong>{{ txn.summary }}</strong>
            <span v-if="txn.paid">($\{{ txn.paid / 100.0 }})</span>
            <span v-for="set in txn.set_gain" :class="'ss ss-' + set.toLowerCase()"></span>
            <span v-for="set in txn.set_loss" :class="'ss ss-' + set.toLowerCase()"></span>
            <span class="actions"><a href="#" @click="start_edit_transaction(txn.id)">edit</a></span>
            <transaction-form
              v-if="mode == 'edit' && target == txn.id"
              mode="edit"
              @updated-transaction="update_transaction($event)"
              @deleted-transaction="delete_transaction(txn.id)"
              :transaction="Object.assign({}, txn)"></transaction-form>
          </li>
        </ul>
      </div>
    </div>
  </template>
</div>
`
});

Vue.component('gainloss-status', {
  props: ['status'],
  template: `
    <div class="status">
      <span v-if="status == 'working'" class="in-progress">‚åõ validating these cards...</span>
      <span v-else-if="status == 'ok'" class="ok">üëç everything checks out with these cards!</span>
    </div>
`
});
Vue.component('transaction-form', {
  props: {
    mode: String,
    transaction: {
      type: Object,
      default: function() {
        return {
          summary:     '',
          dated: (new Date()).toISOString().slice(0,10),
          notes:       '',
          gain:        '',
          loss:        '',
          disposition: 'buy',
        };
      }
    }
  },
  data() {
    return {
      ok: true,
      working: false,
      problems: {
        gain: [],
        loss: []
      },
      valid: {
        gain: "",
        loss: ""
      }
    };
  },
  methods: {
    today() {
      // YYYY-MM-DD format = the first 10 chars in ISO format
      return (new Date()).toISOString().slice(0,10);
    },

    validate(bucket) {
      this.working = true;

      window.setTimeout(() => { // add a barely perceptible delay
        if (bucket == 'gain') {
          this.problems.gain = cardboard.CDIF.validate(this.transaction.gain, UI.vault ,1);
          this.valid.gain = this.transaction.gain;
        } else {
          this.problems.loss = cardboard.CDIF.validate(this.transaction.loss, UI.vault ,1);
          this.valid.loss = this.transaction.loss;
        }
        this.ok = this.can_we_submit();
        this.working = false;
      }, 400);
    },

    changed() {
      let trim = s => s.replace(/(^\s+|\s+$)/g, '').replace(/\s+/g, ' ');
      return trim(this.valid.gain) != trim(this.transaction.gain)
          || trim(this.valid.loss) != trim(this.transaction.loss);
    },

    setPaid(v) {
      v = v.replace(/^\s*$\s*/, '');
      this.transaction.paid = parseInt(parseFloat(v) * 100);
      if (isNaN(this.transaction.paid)) {
        this.transaction.paid = null;
      }
    },

    getPaid() {
      if (!this.transaction.paid) {
        return "";
      }
      let dollars = parseInt(this.transaction.paid / 100);
      let cents = this.transaction.paid % 100;
      if (cents < 10) {
        return dollars.toString() + '.0' + cents.toString();
      } else {
        return dollars.toString() + '.' + cents.toString();
      }
    },

    are_we_ok() {
      if (this.changed()) {
        return false;
      }
      if (this.transaction.disposition == 'buy') {
        return this.transaction.gain.replace(/\s+/, '') != "" && this.can_we_submit();
      }
      if (this.transaction.disposition == 'sell') {
        return this.transaction.loss.replace(/\s+/, '') != "" && this.can_we_submit();
      }
      if (this.transaction.disposition == 'trade') {
        return this.transaction.gain.replace(/\s+/, '') != ""
            && this.transaction.loss.replace(/\s+/, '') != ""
            && this.can_we_submit();
      }
    },

    status() {
      if (this.working) {
        return "working";
      }
      if (this.are_we_ok()) {
        return "ok";
      }
      return "invalid";
    },

    can_we_submit() {
      if (this.transaction.disposition == 'buy') {
        return this.problems.gain.length == 0;
      }
      if (this.transaction.disposition == 'sell') {
        return this.problems.loss.length == 0;
      }
      if (this.transaction.disposition == 'trade') {
        return this.problems.gain +
               this.problems.loss == 0;
      }
    },

    save() {
      event.preventDefault();

      if (this.transaction.id) {
        cardboard.API.patch_transaction(UI.session, this.transaction)
          .then(data => this.$emit('updated-transaction', data));

      } else {
        cardboard.API.post_transaction(UI.session, this.transaction)
          .then(data => this.$emit('created-transaction', data));
      }
    },
    remove() {
      event.preventDefault();

      cardboard.API.delete_transaction(UI.session, this.transaction.id)
        .then(data => this.$emit('deleted-transaction', this.transaction.id));
    },

    clarified(type, $event) {
      this.working = true;
      if (type == 'gain') {
        this.problems.gain = [];
      } else {
        this.problems.loss = [];
      }

      let lines = this.transaction[type].split("\n");
      lines.splice($event.problem.line - 1, 1, ...$event.replacements.map(r => r[0]+'x '+r[1]));
      this.transaction[type] = lines.join("\n");

      this.validate(type);
    }
  },
  template: `
<form :class="'transaction data-entry ' + mode" @submit="save()">
  <h2 v-if="mode == 'new'">Buy / Sell / Trade Cards</h2>
  <h2 v-else-if="mode == 'edit'">Update Buy / Sell / Trade Details</h2>
  <template v-if="mode == 'import'">
    <input type="hidden" name="summary" v-model="transaction.summary">
    <input type="hidden" name="dated" v-model="transaction.dated">
  </template>
  <template v-else>
    <div class="band">
      <div>
        <div class="control">
          <label for="summary">Summary / Transaction Name</label>
          <input type="text" name="summary" v-model="transaction.summary"
                 class="autofocus"
                 placeholder="A (unique-ish) name for this transaction"
                 data-validate="present;min=3;max=50"
                 data-error-if-missing="Please provide a name, which will be displayed in the timeline."
                 data-error-out-of-bounds="Names must be between 3 and 50 characters long."
                 autocomplete="off">
        </div>
      </div>
    </div>
    <div class="band">
      <div>
        <div class="control">
          <label for="dated">Date of Transaction</label>
          <input type="date" name="dated" v-model="transaction.dated"
                 data-validate="present;format=date;happened"
                 autocomplete="off">
        </div>
      </div>
    </div>
    <div class="band">
      <div>
        <div class="control">
          <label for="notes">Notes</label>
          <textarea name="notes" v-model="transaction.notes"
                    placeholder="(notes, thoughts, context - only visible to you...)"
                    data-validate="max=2000"></textarea>
        </div>
      </div>
    </div>
  </template>
  <div class="band" v-if="mode != 'import'">
    <div>
      <div class="control">
        <label>Type of Transaction</label>

        <ul><li>
          <input type="radio" name="disposition" value="buy" v-model="transaction.disposition">
          <label><strong>Buy</strong> &mdash; this transaction <em>adds</em> cards to the collection.</label>
        </li><li>
          <input type="radio" name="disposition" value="sell" v-model="transaction.disposition">
          <label><strong>Sell</strong> &mdash; this transaction <em>removes</em> cards from the collection.</label>
        </li><li>
          <input type="radio" name="disposition" value="trade" v-model="transaction.disposition">
          <label><strong>Trade</strong> &mdash; this transaction does <em>both</em>.</label>
        </li></ul>
      </div>
    </div>
  </div>
  <div class="band" v-if="transaction.disposition == 'buy'">
    <div v-if="mode != 'import'">
      <div class="control">
        <label>Amount Spent (optional)</label>
        <input type="text" :value="getPaid()"  @change="setPaid($event.target.value)"
               placeholder="(how much did you spend on these new cards?)"></input>
      </div>
    </div>
  </div>
  <div class="band" v-if="transaction.disposition == 'buy'">
    <div v-if="mode != 'import'"
         class="gainloss">
      <div class="control gained">
        <label for="gain">Gained Cards</label>
        <textarea name="gain" v-model="transaction.gain"
                  class="cdif"
                  @blur="validate('gain')"
                  data-validate="present;max=100k"></textarea>
      </div>
      <gainloss-status :status="status()"></gainloss-status>
    </div>
    <div v-else
         class="gainloss">
      <div class="control import gained">
        <label for="gain">What cards do you have?</label>
        <textarea name="gain" v-model="transaction.gain"
                  class="cdif"
                  @blur="validate('gain')"
                  data-validate="present;max=100k"></textarea>
      </div>
      <gainloss-status :status="status()"></gainloss-status>
    </div>
    <div>
      <div class="help no-frills">
        <p>VIF format is designed to be simple.<br>
           First, specify how many cards are gained or lost:</p>
        <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then, what set the printed cards are from:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then the full card oracle name:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
      </div>
    </div>
  </div>
  <clarifier v-if="transaction.disposition == 'buy'"
             v-for="problem in problems.gain" :key="problem.id"
             @clarified="clarified('gain', $event)"
             :problem="problem"></clarifier>

  <div class="band" v-else-if="transaction.disposition == 'sell'">
    <div class="gainloss">
      <div class="control lost">
        <label for="vif">Cards Sold &mdash; these will be removed from your collection.</label>
        <textarea name="loss" v-model="transaction.loss"
                  class="cdif"
                  @blur="validate('loss')"
                  data-validate="present;max=100k"></textarea>
        <gainloss-status :status="status()"></gainloss-status>
      </div>
      <clarifier v-for="problem in problems.loss" :key="problem.id"
                 @clarified="clarified('loss', $event)"
                 :problem="problem"></clarifier>
    </div>
    <div>
      <div class="help no-frills">
        <p>VIF format is designed to be simple.<br>
           First, specify how many cards are gained or lost:</p>
        <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then, what set the printed cards are from:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
        <p>Then the full card oracle name:</p>
        <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
      </div>
    </div>
  </div>

  <template v-else-if="transaction.disposition == 'trade'">
    <div class="band">
      <div class="gainloss">
        <div class="control gained">
          <label for="vif">Cards Gained In Trade&mdash; these will be added to your collection.</label>
          <textarea name="gain" v-model="transaction.gain"
                    class="cdif"
                    @blur="validate('gain')"
                    data-validate="present;max=100k"></textarea>
        </div>
        <gainloss-status :status="status()"></gainloss-status>
        <clarifier v-for="problem in problems.loss" :key="problem.id"
                   @clarified="clarified('loss', $event)"
                   :problem="problem"></clarifier>
      </div>
      <div>
        <div class="help no-frills">
          <p>VIF format is designed to be simple.<br>
             First, specify how many cards are gained or lost:</p>
          <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
          <p>Then, what set the printed cards are from:</p>
          <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
          <p>Then the full card oracle name:</p>
          <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
        </div>
      </div>
    </div>

    <div class="band">
      <div class="gainloss">
        <div class="control lost">
          <label for="vif">Cards Given In Trade &mdash; these will be removed from your collection.</label>
          <textarea name="loss" v-model="transaction.loss"
                    class="cdif"
                    @blur="validate('loss')"
                    data-validate="present;max=100k"></textarea>
        </div>
      </div>
      <div>
        <div class="help no-frills">
          <p>VIF format is designed to be simple.<br>
             First, specify how many cards are gained or lost:</p>
          <p class="example"><span class="segment highlight">4x</span> <span class="segment">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
          <p>Then, what set the printed cards are from:</p>
          <p class="example"><span class="segment">4x</span> <span class="segment highlight">MIR</span> <span class="segment">Lion's Eye Diamond</span></p>
          <p>Then the full card oracle name:</p>
          <p class="example"><span class="segment">4x</span> <span class="segment">MIR</span> <span class="segment highlight">Lion's Eye Diamond</span></p>
        </div>
      </div>
    </div>
  </template>

  <template>
    <div v-if="ok">
      <button class="default safe" type="submit">{{ mode == 'import' ? "Import" : "Update" }} Collection</button>
      <button v-if="mode == 'edit'" @click="remove()" class="danger">Delete This Transaction</button>
    </div>
  </template>
</form>
`
});

Vue.component('clarifier', {
  props: ['problem'], //, 'line', 'cards', 'value', 'error', 'target'],
  data: function () {
    return {
      applying: false,
      replacements: [], // [[n, card], [n, card] ...]
      //counts: new Map()
      counts: {}
    };
  },
  created() {
    this.problem.cards.forEach(card => {
      this.counts[card.id] = 0;
    });
  },
  methods: {
    replace(n, card) {
      let o = {}; o[card.id] = n;
      Object.assign(this.counts, o);
      let spec = card.others
               ? card.set.code + ' *' + card.number + ' ' + card.name
               : card.set.code +                      ' ' + card.name;
      for (let i = 0; i < this.replacements.length; i++) {
        if (this.replacements[i][1] == spec) {
          if (n == 0) {
            this.replacements.splice(i,1);
          } else {
            this.replacements[i][0] = n;
          }
          this.replacements = [...this.replacements];
          return;
        }
      }
      if (n > 0) {
        this.replacements.push([n, spec]);
      }
    },

    increment(card) {
      event.preventDefault();
      this.replace(this.counts[card.id] + 1, card);
    },

    decrement(card) {
      event.preventDefault();
      this.replace(Math.max(0, this.counts[card.id] - 1), card);
    },

    apply() {
      this.applying = true;
      event.preventDefault();
      this.$emit('clarified', {
        problem: this.problem,
        replacements: this.replacements
      });
    }
  },
  template: `
<div class="clarify">
  <div :class="(applying ? 'resolving ' : '') + 'problem'">
    <p>line <span class="lineno">{{ problem.line }}</span>:
            <span class="line">{{ problem.target }}</span>:
            <span class="problem">{{ problem.error }}</span></p>
    <div class="resolution" v-if="replacements.length > 0">
      <ul class="changes">
        <li><del>{{ problem.value }}</del></li>
        <li v-for="r in replacements"><ins>{{ r[0] }}x {{ r[1] }}</ins></li> 
      </ul>
      <div>
        <button @click="apply()" rel="apply">‚úî Apply</button>
      </div>
    </div>
    <div class="grid results">
      <span v-for="card in problem.cards">
        <card :key="card.id" :card="card"></card>
        <span class="clarif" :data-n="counts[card.id]">
          <span class="band">
            <a href="#" rel="dec" @click="decrement(card)">‚óÄ</a>
            <span>{{ counts[card.id] }}</span>
            <a href="#" rel="inc" @click="increment(card)">‚ñ∂</a>
          </span>
        </span>
      </span>
    </div>
  </div>
</div>
`
});

window.UI = new Vue({
  el: '#app',
  data: {
    // A session object, representing the currently authenticated
    // collector.  Contains their username, personal details, and
    // internal identifiers as sub-keys.
    //
    session: undefined,

    mode: 'landing',
    modal: false,

    sets: [],
    decks: [],

    transactions: [],

    search: {
      results: []
    },

    docs: undefined,

    changes: [],

    vault: new cardboard.Vault()
  },
  mounted() {
    var session = (function () {
      var cookies = document.cookie.split(/; */);
      for (var i = 0; i < cookies.length; i++) {
        var kv = cookies[i].split('=');
        if (kv[0] == 'vcb_sesh') {
          return kv[1];
        }
      }
      return undefined;
    })();

    cardboard.API.load(this.vault)
      .catch(e => console.log('vault:: failed to load card / pricing data: %s', e));

    if (session) {
      cardboard.API.whoami(session).then(data => {
        UI.session = data.authenticated;
        cardboard.When.trigger('authenticated');

        if (!UI.session || !UI.session.uid) {
          this.vault.no_collection();
          return;
        }
        cardboard.API.fetch_collection_for(UI.session.uid)
          .then(c => cardboard.When(cardboard.CardsLoaded, () => {
            UI.vault.load_collection(c.base, c.patches);
          }));
      });

    } else {
      cardboard.When.trigger('authenticated');
      this.vault.no_collection();
    }
  },
  methods: {
    redraw(mode) {
      if (UI.mode != mode) {
        $('html, body').animate({ scrollTop: 0 }, 200);
      }
      UI.mode = mode;
    },

    browse(url) {
      console.log('browsing to [%s]...');
      document.location.hash = '#!'+(url || '/');
      $(window).trigger('hashchange');
    },

    goto(sub) {
      if (event) { event.preventDefault(); }
      document.location.href = "#!/"+sub;

      if (sub == "" || sub == "login" || sub == "signup") {
        UI.redraw(sub);

      } else if (sub == "logout") {
        UI.session = undefined;
        document.cookie = 'vcb_sesh=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        this.browse();

      } else if (sub.match(/^changelog(\/.*)?$/)) {
        UI.redraw('loading');
        fetch('/changelog.json').then(r => {
          if (!r.ok) { throw new Error('failed to get changelog...'); }
          return r.json();
        }).then(data => {
          UI.changes = data.changelog
          UI.redraw('changelog');
        });

      } else if (sub == "docs") {
        if (!UI.docs) {
          fetch('/docs.html').then(r => {
            if (!r.ok) { throw new Error('unable to load docs'); }
            return r.text();
          }).then(text => {
            UI.docs = text;
            UI.redraw('docs');
          });
        } else {
          UI.redraw('docs');
        }

      } else if (sub == "sets") {
        UI.redraw('loading');
        cardboard.When(cardboard.CardsLoaded, () => {
          UI.sets = UI.vault.sets;
          UI.redraw('sets');
        });

      } else if (sub == "decks") {
        UI.redraw('loading');
        cardboard.When('authenticated', () =>
          cardboard.API.fetch_decks_for(UI.session.uid).then(decks => {
            UI.decks = decks;
            UI.redraw('decks');
          }));

      } else if (sub.match(/^draft(\/.*)?$/)) {
        var set = sub.replace(/^draft\//, '')
                     .replace(/\/.*/, '')
                     .toUpperCase();
        UI.redraw('loading');
        cardboard.When(cardboard.CardsLoaded, () => {
          let land_set = set;
          while (land_set && !UI.vault.has_any('set:'+land_set+' and type:basic land')) {
            land_set = UI.vault.previous_set(land_set);
          }
          UI.draft = new cardboard.Draft(UI.vault, {
            set: set,
            lands: land_set,
          }).pack();
          UI.redraw('draft');
        });

      } else if (sub.match(/^timeline(\/.*)?$/)) {
        // FIXME handle unauth
        UI.redraw('loading');
        cardboard.When('authenticated', () => {
          if (UI.session && UI.session.uid) {
            cardboard.API.fetch_transactions_for(UI.session.uid).then(txns => {
              UI.transactions = txns;
              UI.redraw('timeline');
            })
          } else {
            UI.redraw('login');
          }
        });

      } else if (sub.match(/^q\/./)) {
        UI.doSearch(decodeURIComponent(sub.replace(/^q\//, '')), false);
      }
    },

    forceSearch(q, update) {
      if (event.keyCode == 13) {
        this.doSearch(q, update);
      }
    },
    doSearch(q, update) {
      if (update) {
        document.location.hash = "#!/q/"+encodeURIComponent(q);
      }
      document.title = "VCB :: `"+q+"`";
      UI.redraw('loading');
      UI.search = { query: q, results: [] };
      cardboard.When(cardboard.AllLoaded, () => {
        try {
          let results = UI.vault.search(q);
          UI.search.found = results.length;
          UI.search.results = results.slice(0,400);
          UI.search.more = UI.search.results.length != results.length;
        } catch (e) {
          UI.search.error = e.toString();
        }
        UI.redraw('search');
      });
    },

    colorBandStyle(cards) {
      let colors = {};
      cards.forEach(card => {
        if (card.color == '') {
          colors['C'] = (colors['C'] || 0) + 1;
          colors.total = (colors.total || 0) + 1;
        } else {
          card.color.split('').forEach(color => {
            colors[color] = (colors[color] || 0) + 1;
            colors.total = (colors.total || 0) + 1;
          });
        }
      });

      var at = 0, n = 0, literal;
      var css = 'linear-gradient(90deg';
      'WUBRGC'.split('').forEach(color => {
        if (!(color in colors)) { return; }
        n++;
        css += ', ';
        switch (color) {
        case 'W': literal = '#EEE6B5'; break;
        case 'U': literal = '#375FB6'; break;
        case 'B': literal = '#333333'; break;
        case 'R': literal = '#AE4441'; break;
        case 'G': literal = '#2F7A5B'; break;
        case 'C': literal = '#CBC9C6'; break;
        }
        if (at > 0) {
          css += ' '+at+'vw, ';
        }
        css += literal;
        if (at > 0) {
          css += ' '+at+'vw'
        }
        at += colors[color] / colors.total * 100.0;
      });
      css += ')';
      if (n == 0) { literal = '#CBC9C6'; }
      if (n <  2) { css = literal; }
      return {
        background: css,
        visibility: 'visible',
        height: '7px'
      };
    },
  },
  template: `
<div id="app">
  <header>
    <h1>Vault of Cardboard</h1>
    <input name="q" placeholder="i.e.: Ral color:RU +draw" autocomplete="off"
           v-model="search.query" @change="doSearch(search.query, true)" @keyup="forceSearch(search.query, true)">
    <nav>
      <li><a>Search</a>
        <nav>
          <li><a href="#!/docs">How do I search?</a></li>
          <li><a href="#!/sets">What sets are there?</a></li>
          <li class="separator"></li>
          <li v-if="session"><a href="#!/q/owned">My Collection</a></li>
          <li v-if="session"><a href="#!/q/own:2+">My Duplicates</a></li>
          <li v-if="session"><a href="#!/q/own:4+">My Playsets</a></li>
          <li v-if="session" class="separator"></li>
          <li><a href="#!/q/type:planeswalker">Planeswalkers</a></li>
          <li><a href="#!/q/=mythic">Mythics</a></li>
          <li><a href="#!/q/+gains? and +loses?">Life Gain + Loss</a></li>
          <li><a href="#!/q/type:land and +damage">Pain Lands</a></li>
          <li><a href="#!/q/usd:10+ and usd:400-">Expensive Cards</a></li>
        </nav></li>
      <li v-if="!session"><a href="#!/login" rel="login">Sign in</a></li>
      <li v-if="session"><a class="-username">{{ session.username }}</a>
        <nav>
          <li><a href="#!/timeline">My Collection</a></li>
          <li v-if="session.cohort != 'stable'"><a href="#!/decks">Decks</a></li>
          <li><a href="#!/logout" rel="logout">Sign out</a></li>
        </nav></li>
    </nav>
  </header>
  <div v-if="mode == 'search' && search.results.length > 0"
       class="colors" :style="colorBandStyle(search.results)"></div>
  <div id="main">
    <!--
    <div class="prose"><form class="data-entry">
      <h2>Title of the Form</h2>
      <div class="band">
        <div>
          <div class="control">
            <label for="control-1">A Text Input</label>
            <input type="text" name="control-1" class="autofocus" autocomplete="off">
          </div>
        </div>
      </div>
      <div class="band error">
        <div>
          <div class="control">
            <label for="control-2">A Date Input</label>
            <input type="date" name="control-2">
            <div class="error">Excepteur sint occaecat cupidatat non proident</div>
          </div>
        </div>
        <div>
          <div class="help">
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip.</p>
          </div>
        </div>
      </div>
      <div class="band">
        <div>
          <div class="control">
            <label for="control-3">A Text Area</label>
            <textarea name="control-3"></textarea>
          </div>
        </div>
      </div>

      <div class="band">
        <div>
          <div class="control">
            <label for="control-4">A Text Input</label>
            <input type="text" name="control-4" class="autofocus" autocomplete="off">
          </div>
        </div>
        <div>
          <div class="help">
            <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip.</p>
          </div>
        </div>
      </div>
      <div class="band">
        <div>
          <div class="control">
            <label for="control-5">A Date Input</label>
            <input type="date" name="control-5">
          </div>
        </div>
        <div>
          <div class="help">
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip.</p>
          </div>
        </div>
      </div>
      <div class="band error">
        <div>
          <div class="control">
            <label for="control-6">A Text Area</label>
            <textarea name="control-6" rows="12"></textarea>
            <div class="error">Excepteur sint occaecat cupidatat non proident</div>
          </div>
        </div>
        <div>
          <div class="help">
            <p>Consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
          </div>
        </div>
      </div>
    </form></div>
    -->
    <loading v-if="mode == 'loading'"></loading>
    <signup v-else-if="mode == 'signup'"></signup>
    <login v-else-if="mode == 'login'"></login>
    <card-grid
      v-else-if="mode == 'search'"
      :q="search.query"
      :found="search.found"
      :more="search.more"
      :oops="search.error"
      :cards="search.results"></card-grid>
    <card-grid
      v-else-if="mode == 'draft'"
      :cards="draft"></card-grid>
    <timeline
      v-else-if="mode == 'timeline'"
      :transactions="transactions"></timeline>
    <set-list
      v-else-if="mode == 'sets'"
      :sets="sets"></set-list>
    <deck-list
      v-else-if="mode == 'decks'"
      :decks="decks"></deck-list>
    <deck
      v-else-if="mode == 'deck'"
      :deck="deck"></deck>
    <docs
      v-else-if="mode == 'docs'"
      :docs="docs"></docs>
    <changelog
      v-else-if="mode == 'changelog'"
      :changes="changes"></changelog>
    <div v-else class="landing">
      <div><img src="/img/front.png"></div>
      <div>
        <p>Whether you're putting together <a href="#!/q/type:sliver">that Sliver deck,</a>
        seeking out <a href="#!/q/type:legendary and type:creature">your next Commander,</a>
        or <a href="#!/q/Didgeridoo or type:Minotaur">just looking for some jank</a>,
        <em>Vault of Cardboard</em> has got you covered.</p>

        <p>With a <strong>powerful and flexible query language</strong> that lets you refine
        queries until you find <em>exactly</em> what you're looking for, and a
        <strong>buy / sell / trade</strong> model of <strong>collection management</strong>,
        you'll never again wonder what you have or what you need.</p>

        <div class="buttons">
          <button class="action" rel="signup" @click="goto('signup')">Sign up</button>
          <button class="action" @click="goto('login')">Sign in</button>
        </div>

        <copyright-footer></copyright-footer>
      </div>
    </div>
  </div>

  <div class="modal-bg" v-if="modal"></div>
  <card-detail
    v-if="modal"
    :card="modalfg.card"></card-detail>
</div>
`
});


function tparse(d) { // {{{
  if (typeof d == "string") {
    // because we insist on doing bad things with date formatting in the API...
    m = /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/.exec(d);
    if (!m) {
      console.log("'%s' doesn't look like a date/time string...", d);
      return ""
    }

    d = new Date();
    d.setTime(Date.UTC(parseInt(m[1]),   // year
                      parseInt(m[2])-1, // month
                      parseInt(m[3]),   // day
                      parseInt(m[4]),   // hour
                      parseInt(m[5]),   // minute
                      parseInt(m[6]))); // second
    return d;
  }

  if (!(d instanceof Date)) {
    var _d = new Date()
    if (!isNaN(d)) {
      _d.setTime(d * 1000);
    }
    return _d;
  }

  return d;
} // }}}

var $INDEX = {};

$(function () {
  $(window).on('hashchange', function (event) {
    if (document.location.hash.match(/^#!/)) {
      UI.goto(document.location.hash.replace(/^#!\/?/, ''));
    }
  }).trigger('hashchange');

  $(document.body)
  .on('click',  'header > h1', function (event) {
    event.preventDefault();
    document.location.hash = '#!/';
    goto('');
  })
  .on('click', '.face a[rel=flip]', function (event) {
    event.preventDefault();
    var $card = $(event.target).closest('.face');
    var $img  = $(event.target).closest('.face').find('img');

    if ($card.is('.transform') || $card.is('.double_faced_token')) {
      var src = $img.attr('src');
      $img.attr('src', $img.attr('data-flip-src'));
      $img.attr('data-flip-src', src);

    } else if ($card.is('.flip')) {
      $img.toggleClass('flipped');
    }
  })
  .on('click', '.results .face img', function (event) {
    var id = $(event.target).closest('[data-id]').attr('data-id');
    UI.modalfg = { card: UI.vault.card(id) };
    UI.modal = true;
  })
  .on('click', '.oops ul a[href="#more"]', function (event) {
    event.preventDefault();
    $(event.target).closest('ul').find('li.suppress').show();
    $(event.target).closest('li').hide();
  })
  .on('click', '.modal-fg a.close', function (event) {
    event.preventDefault();
    UI.modal = false;
  })
});
</script>
</body>
</html>
